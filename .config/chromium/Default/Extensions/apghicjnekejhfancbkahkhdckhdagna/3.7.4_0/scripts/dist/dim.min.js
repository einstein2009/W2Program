function sum(a,b){return _.reduce(a,function(a,c,d){return a+_.iteratee(b)(c,d)},0)}function count(a,b){return sum(a,function(a,c){return _.iteratee(b)(a,c)?1:0})}function addFilter(a){var b=$("input[name=filter]"),c=!1;if("item name"===a&&(c=!0,a=prompt("Enter an item name:"),a=a.trim()),0==a.indexOf("light:")){var d=a.substring(6),e=prompt("Enter a light value:");if(!e)return;switch(e=e.trim(),a="light:",d){case"value":a+=e;break;case">value":a+=">"+e;break;case">=value":a+=">="+e;break;case"<value":a+="<"+e;break;case"<=value":a+="<="+e;break;default:a=""}}var f=b.val();c?b.val(a+(f.length>0?" "+f:"")):(f+" ").indexOf(a+" ")<0&&(f.length>0?b.val(f+" "+a):b.val(a)),b.change()}!function(a,b){"use strict";angular.module("toaster",[]).constant("toasterConfig",{limit:0,"tap-to-dismiss":!0,"close-button":!1,"newest-on-top":!0,"time-out":5e3,"icon-classes":{error:"toast-error",info:"toast-info",wait:"toast-wait",success:"toast-success",warning:"toast-warning"},"body-output-type":"","body-template":"toasterBodyTmpl.html","icon-class":"toast-info","position-class":"toast-top-right","title-class":"toast-title","message-class":"toast-message","prevent-duplicates":!1,"mouseover-timer-stop":!0}).service("toaster",["$rootScope","toasterConfig",function(a,b){function c(a){return function(b,c,d,e,f,g,h,i,j){angular.isString(b)?this.pop(a,b,c,d,e,f,g,h,i,j):this.pop(angular.extend(b,{type:a}))}}this.pop=function(b,c,d,e,f,g,h,i,j,k){if(angular.isObject(b)){var l=b;this.toast={type:l.type,title:l.title,body:l.body,timeout:l.timeout,bodyOutputType:l.bodyOutputType,clickHandler:l.clickHandler,showCloseButton:l.showCloseButton,uid:l.toastId,onHideCallback:l.onHideCallback},j=l.toastId,h=l.toasterId}else this.toast={type:b,title:c,body:d,timeout:e,bodyOutputType:f,clickHandler:g,showCloseButton:i,uid:j,onHideCallback:k};a.$emit("toaster-newToast",h,j)},this.clear=function(b,c){a.$emit("toaster-clearToasts",b,c)};for(var d in b["icon-classes"])this[d]=c(d)}]).factory("toasterEventRegistry",["$rootScope",function(a){var b,c=null,d=null,e=[],f=[];return b={setup:function(){c||(c=a.$on("toaster-newToast",function(a,b,c){for(var d=0,f=e.length;f>d;d++)e[d](a,b,c)})),d||(d=a.$on("toaster-clearToasts",function(a,b,c){for(var d=0,e=f.length;e>d;d++)f[d](a,b,c)}))},subscribeToNewToastEvent:function(a){e.push(a)},subscribeToClearToastsEvent:function(a){f.push(a)},unsubscribeToNewToastEvent:function(a){var b=e.indexOf(a);b>=0&&e.splice(b,1),0===e.length&&(c(),c=null)},unsubscribeToClearToastsEvent:function(a){var b=f.indexOf(a);b>=0&&f.splice(b,1),0===f.length&&(d(),d=null)}},{setup:b.setup,subscribeToNewToastEvent:b.subscribeToNewToastEvent,subscribeToClearToastsEvent:b.subscribeToClearToastsEvent,unsubscribeToNewToastEvent:b.unsubscribeToNewToastEvent,unsubscribeToClearToastsEvent:b.unsubscribeToClearToastsEvent}}]).directive("directiveTemplate",["$compile",function(a){return{restrict:"A",scope:{directiveName:"@directiveName"},replace:!0,link:function(b,c,d){b.$watch("directiveName",function(d){var e=a("<div "+d+"></div>")(b);c.append(e)})}}}]).directive("toasterContainer",["$parse","$rootScope","$interval","$sce","toasterConfig","toaster","toasterEventRegistry",function(a,b,c,d,e,f,g){return{replace:!0,restrict:"EA",scope:!0,link:function(b,h,i){function j(a,d){a.timeoutPromise=c(function(){b.removeToast(a.id)},d,1)}function k(c,e){if(c.type=o["icon-classes"][c.type],c.type||(c.type=o["icon-class"]),o["prevent-duplicates"]===!0)if(n(e)){if(b.toasters.length>0&&b.toasters[b.toasters.length-1].body===c.body)return}else{var f,g;for(f=0,g=b.toasters.length;g>f;f++)b.toasters[f].uid===e&&(l(f),f--,g=b.toasters.length)}c.id=++p,n(e)||(c.uid=e);var h=o["close-button"];if("boolean"==typeof c.showCloseButton);else if("boolean"==typeof h)c.showCloseButton=h;else if("object"==typeof h){var i=h[c.type];"undefined"!=typeof i&&null!==i&&(c.showCloseButton=i)}else c.showCloseButton=!1;switch(c.bodyOutputType=c.bodyOutputType||o["body-output-type"],c.bodyOutputType){case"trustedHtml":c.html=d.trustAsHtml(c.body);break;case"template":c.bodyTemplate=c.body||o["body-template"];break;case"templateWithData":var j=a(c.body||o["body-template"]),k=j(b);c.bodyTemplate=k.template,c.data=k.data;break;case"directive":c.html=c.body}b.configureTimer(c),o["newest-on-top"]===!0?(b.toasters.unshift(c),o.limit>0&&b.toasters.length>o.limit&&b.toasters.pop()):(b.toasters.push(c),o.limit>0&&b.toasters.length>o.limit&&b.toasters.shift())}function l(a){var d=b.toasters[a];d&&(d.timeoutPromise&&c.cancel(d.timeoutPromise),b.toasters.splice(a,1),angular.isFunction(d.onHideCallback)&&d.onHideCallback())}function m(a){for(var c=b.toasters.length-1;c>=0;c--)n(a)?l(c):b.toasters[c].uid==a&&l(c)}function n(a){return angular.isUndefined(a)||null===a}var o,p=0;o=angular.extend({},e,b.$eval(i.toasterOptions)),b.config={toasterId:o["toaster-id"],position:o["position-class"],title:o["title-class"],message:o["message-class"],tap:o["tap-to-dismiss"],closeButton:o["close-button"],animation:o["animation-class"],mouseoverTimer:o["mouseover-timer-stop"]},b.$on("$destroy",function(){g.unsubscribeToNewToastEvent(b._onNewToast),g.unsubscribeToClearToastsEvent(b._onClearToasts)}),b.configureTimer=function(a){var b=angular.isNumber(a.timeout)?a.timeout:o["time-out"];"object"==typeof b&&(b=b[a.type]),b>0&&j(a,b)},b.removeToast=function(a){var c,d;for(c=0,d=b.toasters.length;d>c;c++)if(b.toasters[c].id===a){l(c);break}},b.toasters=[],b._onNewToast=function(a,c,d){(n(b.config.toasterId)&&n(c)||!n(b.config.toasterId)&&!n(c)&&b.config.toasterId==c)&&k(f.toast,d)},b._onClearToasts=function(a,c,d){("*"==c||n(b.config.toasterId)&&n(c)||!n(b.config.toasterId)&&!n(c)&&b.config.toasterId==c)&&m(d)},g.setup(),g.subscribeToNewToastEvent(b._onNewToast),g.subscribeToClearToastsEvent(b._onClearToasts)},controller:["$scope","$element","$attrs",function(a,b,d){a.stopTimer=function(b){a.config.mouseoverTimer===!0&&(b.stopTimerClass="stop-timer",b.timeoutPromise&&(c.cancel(b.timeoutPromise),b.timeoutPromise=null))},a.restartTimer=function(b){a.config.mouseoverTimer===!0?b.timeoutPromise||(b.stopTimerClass="",a.configureTimer(b)):null===b.timeoutPromise&&a.removeToast(b.id)},a.click=function(b,c){if(a.config.tap===!0||b.showCloseButton===!0&&c===!0){var d=!0;b.clickHandler&&(angular.isFunction(b.clickHandler)?d=b.clickHandler(b,c):angular.isFunction(a.$parent.$eval(b.clickHandler))?d=a.$parent.$eval(b.clickHandler)(b,c):console.log("TOAST-NOTE: Your click handler is not inside a parent scope of toaster-container.")),d&&a.removeToast(b.id)}}}],template:'<div id="toast-container" ng-class="[config.position, config.animation]"><div ng-repeat="toaster in toasters" class="toast" ng-class="[toaster.type,toaster.stopTimerClass]" ng-click="click(toaster)" ng-mouseover="stopTimer(toaster)" ng-mouseout="restartTimer(toaster)"><button type="button" class="toast-close-button" ng-show="toaster.showCloseButton" ng-click="click(toaster, true)">&times;</button><div ng-class="config.title">{{toaster.title}}</div><div ng-class="config.message" ng-switch on="toaster.bodyOutputType"><div ng-switch-when="trustedHtml" ng-bind-html="toaster.html"></div><div ng-switch-when="template"><div ng-include="toaster.bodyTemplate"></div></div><div ng-switch-when="templateWithData"><div ng-include="toaster.bodyTemplate"></div></div><div ng-switch-when="directive"><div directive-template directive-name="{{toaster.html}}"></div></div><div ng-switch-default >{{toaster.body}}</div></div></div></div>'}}])}(window,document),function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){!function(){function b(a,b,c){return[parseFloat(a[0])*(n.test(a[0])?b/100:1),parseFloat(a[1])*(n.test(a[1])?c/100:1)]}function c(b,c){return parseInt(a.css(b,c),10)||0}function d(b){var c=b[0];return 9===c.nodeType?{width:b.width(),height:b.height(),offset:{top:0,left:0}}:a.isWindow(c)?{width:b.width(),height:b.height(),offset:{top:b.scrollTop(),left:b.scrollLeft()}}:c.preventDefault?{width:0,height:0,offset:{top:c.pageY,left:c.pageX}}:{width:b.outerWidth(),height:b.outerHeight(),offset:b.offset()}}a.ui=a.ui||{};var e,f,g=Math.max,h=Math.abs,i=Math.round,j=/left|center|right/,k=/top|center|bottom/,l=/[\+\-]\d+(\.[\d]+)?%?/,m=/^\w+/,n=/%$/,o=a.fn.position;a.position={scrollbarWidth:function(){if(void 0!==e)return e;var b,c,d=a("<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),f=d.children()[0];return a("body").append(d),b=f.offsetWidth,d.css("overflow","scroll"),c=f.offsetWidth,b===c&&(c=d[0].clientWidth),d.remove(),e=b-c},getScrollInfo:function(b){var c=b.isWindow||b.isDocument?"":b.element.css("overflow-x"),d=b.isWindow||b.isDocument?"":b.element.css("overflow-y"),e="scroll"===c||"auto"===c&&b.width<b.element[0].scrollWidth,f="scroll"===d||"auto"===d&&b.height<b.element[0].scrollHeight;return{width:f?a.position.scrollbarWidth():0,height:e?a.position.scrollbarWidth():0}},getWithinInfo:function(b){var c=a(b||window),d=a.isWindow(c[0]),e=!!c[0]&&9===c[0].nodeType;return{element:c,isWindow:d,isDocument:e,offset:c.offset()||{left:0,top:0},scrollLeft:c.scrollLeft(),scrollTop:c.scrollTop(),width:d||e?c.width():c.outerWidth(),height:d||e?c.height():c.outerHeight()}}},a.fn.position=function(e){if(!e||!e.of)return o.apply(this,arguments);e=a.extend({},e);var n,p,q,r,s,t,u=a(e.of),v=a.position.getWithinInfo(e.within),w=a.position.getScrollInfo(v),x=(e.collision||"flip").split(" "),y={};return t=d(u),u[0].preventDefault&&(e.at="left top"),p=t.width,q=t.height,r=t.offset,s=a.extend({},r),a.each(["my","at"],function(){var a,b,c=(e[this]||"").split(" ");1===c.length&&(c=j.test(c[0])?c.concat(["center"]):k.test(c[0])?["center"].concat(c):["center","center"]),c[0]=j.test(c[0])?c[0]:"center",c[1]=k.test(c[1])?c[1]:"center",a=l.exec(c[0]),b=l.exec(c[1]),y[this]=[a?a[0]:0,b?b[0]:0],e[this]=[m.exec(c[0])[0],m.exec(c[1])[0]]}),1===x.length&&(x[1]=x[0]),"right"===e.at[0]?s.left+=p:"center"===e.at[0]&&(s.left+=p/2),"bottom"===e.at[1]?s.top+=q:"center"===e.at[1]&&(s.top+=q/2),n=b(y.at,p,q),s.left+=n[0],s.top+=n[1],this.each(function(){var d,j,k=a(this),l=k.outerWidth(),m=k.outerHeight(),o=c(this,"marginLeft"),t=c(this,"marginTop"),z=l+o+c(this,"marginRight")+w.width,A=m+t+c(this,"marginBottom")+w.height,B=a.extend({},s),C=b(y.my,k.outerWidth(),k.outerHeight());"right"===e.my[0]?B.left-=l:"center"===e.my[0]&&(B.left-=l/2),"bottom"===e.my[1]?B.top-=m:"center"===e.my[1]&&(B.top-=m/2),B.left+=C[0],B.top+=C[1],f||(B.left=i(B.left),B.top=i(B.top)),d={marginLeft:o,marginTop:t},a.each(["left","top"],function(b,c){a.ui.position[x[b]]&&a.ui.position[x[b]][c](B,{targetWidth:p,targetHeight:q,elemWidth:l,elemHeight:m,collisionPosition:d,collisionWidth:z,collisionHeight:A,offset:[n[0]+C[0],n[1]+C[1]],my:e.my,at:e.at,within:v,elem:k})}),e.using&&(j=function(a){var b=r.left-B.left,c=b+p-l,d=r.top-B.top,f=d+q-m,i={target:{element:u,left:r.left,top:r.top,width:p,height:q},element:{element:k,left:B.left,top:B.top,width:l,height:m},horizontal:0>c?"left":b>0?"right":"center",vertical:0>f?"top":d>0?"bottom":"middle"};l>p&&h(b+c)<p&&(i.horizontal="center"),m>q&&h(d+f)<q&&(i.vertical="middle"),g(h(b),h(c))>g(h(d),h(f))?i.important="horizontal":i.important="vertical",e.using.call(this,a,i)}),k.offset(a.extend(B,{using:j}))})},a.ui.position={fit:{left:function(a,b){var c,d=b.within,e=d.isWindow?d.scrollLeft:d.offset.left,f=d.width,h=a.left-b.collisionPosition.marginLeft,i=e-h,j=h+b.collisionWidth-f-e;b.collisionWidth>f?i>0&&0>=j?(c=a.left+i+b.collisionWidth-f-e,a.left+=i-c):j>0&&0>=i?a.left=e:i>j?a.left=e+f-b.collisionWidth:a.left=e:i>0?a.left+=i:j>0?a.left-=j:a.left=g(a.left-h,a.left)},top:function(a,b){var c,d=b.within,e=d.isWindow?d.scrollTop:d.offset.top,f=b.within.height,h=a.top-b.collisionPosition.marginTop,i=e-h,j=h+b.collisionHeight-f-e;b.collisionHeight>f?i>0&&0>=j?(c=a.top+i+b.collisionHeight-f-e,a.top+=i-c):j>0&&0>=i?a.top=e:i>j?a.top=e+f-b.collisionHeight:a.top=e:i>0?a.top+=i:j>0?a.top-=j:a.top=g(a.top-h,a.top)}},flip:{left:function(a,b){var c,d,e=b.within,f=e.offset.left+e.scrollLeft,g=e.width,i=e.isWindow?e.scrollLeft:e.offset.left,j=a.left-b.collisionPosition.marginLeft,k=j-i,l=j+b.collisionWidth-g-i,m="left"===b.my[0]?-b.elemWidth:"right"===b.my[0]?b.elemWidth:0,n="left"===b.at[0]?b.targetWidth:"right"===b.at[0]?-b.targetWidth:0,o=-2*b.offset[0];0>k?(c=a.left+m+n+o+b.collisionWidth-g-f,(0>c||c<h(k))&&(a.left+=m+n+o)):l>0&&(d=a.left-b.collisionPosition.marginLeft+m+n+o-i,(d>0||h(d)<l)&&(a.left+=m+n+o))},top:function(a,b){var c,d,e=b.within,f=e.offset.top+e.scrollTop,g=e.height,i=e.isWindow?e.scrollTop:e.offset.top,j=a.top-b.collisionPosition.marginTop,k=j-i,l=j+b.collisionHeight-g-i,m="top"===b.my[1],n=m?-b.elemHeight:"bottom"===b.my[1]?b.elemHeight:0,o="top"===b.at[1]?b.targetHeight:"bottom"===b.at[1]?-b.targetHeight:0,p=-2*b.offset[1];0>k?(d=a.top+n+o+p+b.collisionHeight-g-f,(0>d||d<h(k))&&(a.top+=n+o+p)):l>0&&(c=a.top-b.collisionPosition.marginTop+n+o+p-i,(c>0||h(c)<l)&&(a.top+=n+o+p))}},flipfit:{left:function(){a.ui.position.flip.left.apply(this,arguments),a.ui.position.fit.left.apply(this,arguments)},top:function(){a.ui.position.flip.top.apply(this,arguments),a.ui.position.fit.top.apply(this,arguments)}}},function(){var b,c,d,e,g,h=document.getElementsByTagName("body")[0],i=document.createElement("div");b=document.createElement(h?"div":"body"),d={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},h&&a.extend(d,{position:"absolute",left:"-1000px",top:"-1000px"});for(g in d)b.style[g]=d[g];b.appendChild(i),c=h||document.documentElement,c.insertBefore(b,c.firstChild),i.style.cssText="position: absolute; left: 10.7432222px;",e=a(i).offset().left,f=e>10&&11>e,b.innerHTML="",c.removeChild(b)}()}();a.ui.position}),function(a){a.isScrollToFixed=function(b){return!!a(b).data("ScrollToFixed")},a.ScrollToFixed=function(b,c){function d(){w.trigger("preUnfixed.ScrollToFixed"),k(),w.trigger("unfixed.ScrollToFixed"),A=-1,x=w.offset().top,y=w.offset().left,q.options.offsets&&(y+=w.offset().left-w.position().left),-1==z&&(z=y),r=w.css("position"),v=!0,-1!=q.options.bottom&&(w.trigger("preFixed.ScrollToFixed"),i(),w.trigger("fixed.ScrollToFixed"))}function e(){var a=q.options.limit;return a?"function"==typeof a?a.apply(w):a:0}function f(){return"fixed"===r}function g(){return"absolute"===r}function h(){return!(f()||g())}function i(){f()||(B.css({display:w.css("display"),width:w.outerWidth(!0),height:w.outerHeight(!0),"float":w.css("float")}),cssOptions={"z-index":q.options.zIndex,position:"fixed",top:-1==q.options.bottom?m():"",bottom:-1==q.options.bottom?"":q.options.bottom,"margin-left":"0px"},q.options.dontSetWidth||(cssOptions.width=w.width()),w.css(cssOptions),w.addClass(q.options.baseClassName),q.options.className&&w.addClass(q.options.className),r="fixed")}function j(){var a=e(),b=y;q.options.removeOffsets&&(b="",a-=x),cssOptions={position:"absolute",top:a,left:b,"margin-left":"0px",bottom:""},q.options.dontSetWidth||(cssOptions.width=w.width()),w.css(cssOptions),r="absolute"}function k(){h()||(A=-1,B.css("display","none"),w.css({"z-index":u,width:"",position:s,left:"",top:t,"margin-left":""}),w.removeClass("scroll-to-fixed-fixed"),q.options.className&&w.removeClass(q.options.className),r=null)}function l(a){a!=A&&(w.css("left",y-a),A=a)}function m(){var a=q.options.marginTop;return a?"function"==typeof a?a.apply(w):a:0}function n(){if(a.isScrollToFixed(w)){var b=v;v?h()&&(x=w.offset().top,y=w.offset().left):d();var c=a(window).scrollLeft(),n=a(window).scrollTop(),r=e();q.options.minWidth&&a(window).width()<q.options.minWidth?h()&&b||(p(),w.trigger("preUnfixed.ScrollToFixed"),k(),w.trigger("unfixed.ScrollToFixed")):q.options.maxWidth&&a(window).width()>q.options.maxWidth?h()&&b||(p(),w.trigger("preUnfixed.ScrollToFixed"),k(),w.trigger("unfixed.ScrollToFixed")):-1==q.options.bottom?r>0&&n>=r-m()?g()&&b||(p(),w.trigger("preAbsolute.ScrollToFixed"),j(),w.trigger("unfixed.ScrollToFixed")):n>=x-m()?(f()&&b||(p(),w.trigger("preFixed.ScrollToFixed"),i(),A=-1,w.trigger("fixed.ScrollToFixed")),l(c)):h()&&b||(p(),w.trigger("preUnfixed.ScrollToFixed"),k(),w.trigger("unfixed.ScrollToFixed")):r>0?n+a(window).height()-w.outerHeight(!0)>=r-(m()||-o())?f()&&(p(),w.trigger("preUnfixed.ScrollToFixed"),"absolute"===s?j():k(),w.trigger("unfixed.ScrollToFixed")):(f()||(p(),w.trigger("preFixed.ScrollToFixed"),i()),l(c),w.trigger("fixed.ScrollToFixed")):l(c)}}function o(){return q.options.bottom?q.options.bottom:0}function p(){var a=w.css("position");"absolute"==a?w.trigger("postAbsolute.ScrollToFixed"):"fixed"==a?w.trigger("postFixed.ScrollToFixed"):w.trigger("postUnfixed.ScrollToFixed")}var q=this;q.$el=a(b),q.el=b,q.$el.data("ScrollToFixed",q);var r,s,t,u,v=!1,w=q.$el,x=0,y=0,z=-1,A=-1,B=null,C=function(a){w.is(":visible")&&(v=!1,n())},D=function(a){window.requestAnimationFrame?requestAnimationFrame(n):n()},E=function(a){a=a||window.event,a.preventDefault&&a.preventDefault(),a.returnValue=!1};q.init=function(){q.options=a.extend({},a.ScrollToFixed.defaultOptions,c),u=w.css("z-index"),q.$el.css("z-index",q.options.zIndex),B=a('<div class="fixed-header-placeholder" />'),r=w.css("position"),s=w.css("position"),t=w.css("top"),h()&&q.$el.after(B),a(window).bind("resize.ScrollToFixed",C),a(window).bind("scroll.ScrollToFixed",D),"ontouchmove"in window&&a(window).bind("touchmove.ScrollToFixed",n),q.options.preFixed&&w.bind("preFixed.ScrollToFixed",q.options.preFixed),q.options.postFixed&&w.bind("postFixed.ScrollToFixed",q.options.postFixed),q.options.preUnfixed&&w.bind("preUnfixed.ScrollToFixed",q.options.preUnfixed),q.options.postUnfixed&&w.bind("postUnfixed.ScrollToFixed",q.options.postUnfixed),q.options.preAbsolute&&w.bind("preAbsolute.ScrollToFixed",q.options.preAbsolute),q.options.postAbsolute&&w.bind("postAbsolute.ScrollToFixed",q.options.postAbsolute),q.options.fixed&&w.bind("fixed.ScrollToFixed",q.options.fixed),q.options.unfixed&&w.bind("unfixed.ScrollToFixed",q.options.unfixed),q.options.spacerClass&&B.addClass(q.options.spacerClass),w.bind("resize.ScrollToFixed",function(){B.height(w.height())}),w.bind("scroll.ScrollToFixed",function(){w.trigger("preUnfixed.ScrollToFixed"),k(),w.trigger("unfixed.ScrollToFixed"),n()}),w.bind("detach.ScrollToFixed",function(b){E(b),w.trigger("preUnfixed.ScrollToFixed"),k(),w.trigger("unfixed.ScrollToFixed"),a(window).unbind("resize.ScrollToFixed",C),a(window).unbind("scroll.ScrollToFixed",D),w.unbind(".ScrollToFixed"),B.remove(),q.$el.removeData("ScrollToFixed")}),C()},q.init()},a.ScrollToFixed.defaultOptions={marginTop:0,limit:0,bottom:-1,zIndex:1e3,baseClassName:"scroll-to-fixed-fixed"},a.fn.scrollToFixed=function(b){return this.each(function(){new a.ScrollToFixed(this,b)})}}(jQuery),function(){"use strict";angular.module("dimApp",["ui.router","ngAnimate","ngAria","ngDialog","ngMessages","ang-drag-drop","chromeStorage","angularUUID2","toaster","ajoslin.promise-tracker","cfp.hotkeys","rzModule"])}(),function(){"use strict";angular.module("dimApp").value("dimPlatformIds",{xbl:null,psn:null}).value("dimState",{membershipType:-1,active:null,debug:!0}).value("dimItemTier",{exotic:"Exotic",legendary:"Legendary",rare:"Rare",uncommon:"Uncommon",basic:"Basic"}).value("dimCategory",{Weapons:["Class","Primary","Special","Heavy"],Armor:["Helmet","Gauntlets","Chest","Leg","ClassItem"],General:["Artifact","Ghost","Consumable","Material","Emblem","Shader","Emote","Ship","Vehicle","Horn"],Progress:["Bounties","Quests","Missions"],Postmaster:["Lost Items","Special Orders","Messages"]}).factory("loadingTracker",["promiseTracker",function(a){return a()}]),angular.module("dimApp").run(["$rootScope","loadingTracker","$timeout","toaster","$http","dimInfoService",function(a,b,c,d,e,f){a.loadingTracker=b,a.inactivityLength=36e5,a.isUserInactive=function(){var b=Date.now();return b-a.lastActivity>a.inactivityLength},a.trackActivity=function(){a.lastActivity=Date.now()},a.trackActivity(),f.show("20160411v36",{title:"DIM v3.6.0 Released",view:"views/changelog-toaster.html?v=v3.6.0"})}]),angular.module("dimApp").config(["hotkeysProvider",function(a){a.includeCheatSheet=!1}]).config(["$compileProvider",function(a){a.imgSrcSanitizationWhitelist(/^\s*((https?|chrome-extension):|data:image\/)/)}]).config(["rateLimiterConfigProvider",function(a){a.addLimiter(/www\.bungie\.net\/Platform\/Destiny\/TransferItem/,1,1100),a.addLimiter(/www\.bungie\.net\/Platform\/Destiny\/EquipItem/,1,1100)}]).config(["$httpProvider",function(a){a.interceptors.push("rateLimiterInterceptor")}]).config(function(a,b){b.otherwise("/inventory"),a.state("inventory",{url:"/inventory",templateUrl:"views/inventory.html"}).state("best",{url:"/best",templateUrl:"views/best.html"})})}(),"object"==typeof window.onerror&&(window.onerror=function(a,b,c){}),function(a){var b=a.onerror;a.onerror=function(a,c,d,e,f){var g=a;return"undefined"!=typeof f&&"undefined"!=typeof f.message&&(g=f.message),"function"==typeof b?b(a,c,d,e,f):!1}}(window),function(a){"use strict";a.module("dimApp").factory("rateLimiterQueue",["$timeout","$window",function(b,c){function d(a,b,d){this.pattern=a,this.requestLimit=b,this.timeLimit=d||1e3,this.queue=[],this.count=0,this.lastRequestTime=c.performance.now(),this.timer=void 0}function e(a,b,c){return new d(a,b,c)}return a.extend(d.prototype,{matches:function(a){return a.match(this.pattern)},add:function(a,b){this.queue.push({config:a,deferred:b}),this.processQueue()},scheduleProcessing:function(){if(!a.isDefined(this.interval)){var d=Math.max(0,this.timeLimit-(c.performance.now()-this.lastRequestTime));this.timer=b(function(){this.timer=void 0,this.processQueue()}.bind(this),d)}},processQueue:function(){for(;this.queue.length;){if(!this.canProcess())return void this.scheduleProcessing();var a=this.queue.shift();a.deferred.resolve(a.config)}},canProcess:function(){var a=c.performance.now(),b=a-this.lastRequestTime;return b>=this.timeLimit&&(this.lastRequestTime=a,this.count=0),this.count<this.requestLimit?(this.count++,!0):!1}}),e}]).provider("rateLimiterConfig",function(){var a=[],b=[];this.addLimiter=function(b,c,d){a.push({pattern:b,requestLimit:c,timeLimit:d})},this.$get=["rateLimiterQueue",function(c){for(;a.length;){var d=a.shift();b.push(c(d.pattern,d.requestLimit,d.timeLimit))}return{getLimiters:function(){return b}}}]}).factory("rateLimiterInterceptor",["$q","rateLimiterConfig",function(a,b){return{request:function(c){var d=_.find(b.getLimiters(),function(a){return a.matches(c.url)});if(d){var e=a.defer();return d.add(c,e),e.promise}return c}}}])}(angular),function(){"use strict";function a(a){var b=[];return{queueAction:function(c){var d=b.length?b[b.length-1]:a.when();d=d.then(function(){return c()},function(){return c()})["finally"](function(){b.shift()}),b.push(d)},wrap:function(a,b){var c=this;return function(){var d=arguments;return c.queueAction(function(){var c=a.apply(b,d);return c})}}}}angular.module("dimApp").factory("dimActionQueue",a),a.$inject=["$q"]}(),function(){"use strict";function a(a,b,c,d,e,f){function g(a,b,c){return a[b]=c,c}function h(a){if(503===a.statue)return b.reject(new Error("Bungie.net is down."));if(a.status<200||a.status>=400)return b.reject(new Error("Network error: "+a.status));var c=a.data.ErrorCode;return 36===c?b.reject(new Error("Bungie API throttling limit exceeded. Please wait a bit and then retry.")):99===c?b.reject(new Error("Please log into Bungie.net in order to use this extension.")):5===c?b.reject(new Error("Bungie.net servers are down for maintenance.")):1618===c&&a.config.url.indexOf("/Account/")>=0&&a.config.url.indexOf("/Character/")<0?b.reject(new Error("No Destiny account was found for this platform.")):c>1?b.reject(new Error(a.data.Message)):a}function i(a){var e=b(function(b,e){function f(){d(a).then(function(a){36===a.data.ErrorCode?(g-=1,0>=g?b(a):c(f,1e3*Math.pow(2,4-g))):b(a)},function(a){a.data?e(new Error(a.data.Message)):-1===a.status?e(new Error("You may not be connected to the internet.")):(console.error("Failed to make service call",a),e(new Error("Failed to make service call.")))})}var g=4;f()});return e}function j(){return b(function(a,b){function c(c){_.size(c)>0?a(c):b(new Error("No cookies found."))}chrome.cookies.getAll({domain:".bungie.net"},c)})}function k(){return G=G||j().then(function(a){return b(function(b,c){var d=_.find(a,function(a){return"bungled"===a.name});_.isUndefined(d)?c(new Error("Please log into Bungie.net in order to use this extension.")):b(d.value)})})["catch"](function(a){G=null})}function l(){return H=H||k().then(m).then(d).then(h)["catch"](function(a){var c=a.message;return-1===a.status&&(c="You may not be connected to the internet."),f.pop("error","Bungie.net Error",c),b.reject(a)})}function m(a){return{method:"GET",url:"https://www.bungie.net/Platform/User/GetBungieNetUser/",headers:{"X-API-Key":F,"x-csrf":a},withCredentials:!0}}function n(a){function c(b){return{method:"GET",url:"https://www.bungie.net/Platform/Destiny/"+a.type+"/Stats/GetMembershipIdByDisplayName/"+a.id+"/",headers:{"X-API-Key":F,"x-csrf":b},withCredentials:!0}}function e(c){return 0===_.size(c.data.Response)?b.reject(new Error("Failed to find a Destiny account for you on "+a.label+".")):b.when(c.data.Response)}function f(c){return-1===c.status?b.reject(new Error("You may not be connected to the internet.")):b.reject(new Error("Failed to find a Destiny account for you on "+a.label+"."))}return I=I||k().then(c).then(d).then(h).then(e,f)["catch"](function(a){return I=null,b.reject(a)})}function o(a){var b={token:null,membershipId:null},c=g.bind(null,b,"token"),e=n.bind(null,a),f=k().then(c).then(e).then(function(c){return p(b.token,a,c)}).then(d).then(h).then(q);return f}function p(a,b,c){return{method:"GET",url:"https://www.bungie.net/Platform/Destiny/Tiger"+(1==b.type?"Xbox":"PSN")+"/Account/"+c+"/",headers:{"X-API-Key":F,"x-csrf":a},withCredentials:!0}}function q(a){return 0===_.size(a.data.Response)?b.reject(new Error("The membership id was not available.")):_.map(a.data.Response.data.characters,function(b){return b.inventory=a.data.Response.data.inventory,{id:b.characterBase.characterId,base:b}})}function r(){return b.when({method:"GET",url:"https://www.bungie.net/Platform/Destiny/Advisors/Xur/",headers:{"X-API-Key":F}}).then(function(a){return d(a)}).then(h).then(function(a){return a.data.Response.data})}function s(a){var c={token:null,membershipId:null},d=g.bind(null,c,"token"),e=g.bind(null,c,"membershipId"),h=g.bind(null,c,"characters"),i=n.bind(null,a),j=o.bind(null,a),l=k().then(d).then(i).then(e).then(j).then(h).then(function(){return w(c.token,a,c.membershipId,c.characters)})["catch"](function(a){return f.pop("error","Bungie.net Error",a.message),b.reject(a)});return l}function t(a,b,c,d){return{method:"GET",url:"https://www.bungie.net/Platform/Destiny/"+b.type+"/Account/"+c+"/Character/"+d.id+"/Inventory/?definitions=false",headers:{"X-API-Key":F,"x-csrf":a},withCredentials:!0}}function u(a,b){return{method:"GET",url:"https://www.bungie.net/Platform/Destiny/"+b.type+"/MyAccount/Vault/?definitions=false",headers:{"X-API-Key":F,"x-csrf":a},withCredentials:!0}}function v(a,b){var c=b.data.Response;return c.id=a.id,c.character=a,c}function w(a,c,e,f){var g=f.map(function(f){var g=v.bind(null,f);return b.when(t(a,c,e,f)).then(d).then(h).then(g)}),i=v.bind(null,{id:"vault",base:null}),j=b.when(u(a,c)).then(d).then(h).then(i);return g.push(j),b.all(g)}function x(a,b,c){var d=e.active,f={token:null,membershipType:null},j=g.bind(null,f,"token"),l=g.bind(null,f,"membershipType"),m=n.bind(null,d),o=k().then(j).then(m).then(l).then(function(){return b}).then(function(b){return z(f.token,d.type,a,b,c)}).then(i).then(function(c){return y(c,a,b)}).then(h);return o}function y(a,c,d){return a&&a.data&&1648===a.data.ErrorCode?(f.pop("warning","Item Uniqueness",["You tried to move the '"+c.name+"'",c.type.toLowerCase(),"to",d.isVault?"the vault":"your "+d.powerLevel+" "+d.race+" "+d.name,"but that destination already has that item and is only allowed one."].join(" ")),b.reject(new Error("move-canceled"))):a}function z(a,b,c,d,e){return{method:"POST",url:"https://www.bungie.net/Platform/Destiny/TransferItem/",headers:{"X-API-Key":F,"x-csrf":a,"content-type":"application/json; charset=UTF-8;"},data:{characterId:d.isVault?c.owner:d.id,membershipType:b,itemId:c.id,itemReferenceHash:c.hash,stackSize:e||c.amount,transferToVault:d.isVault},dataType:"json",withCredentials:!0}}function A(a){var b=e.active,c={token:null,membershipType:null},d=g.bind(null,c,"token"),f=g.bind(null,c,"membershipType"),j=n.bind(null,b),l=k().then(d).then(j).then(f).then(function(){return B(c.token,b.type,a)}).then(i).then(h);return l}function B(a,b,c){return{method:"POST",url:"https://www.bungie.net/Platform/Destiny/EquipItem/",headers:{"X-API-Key":F,"x-csrf":a,"content-type":"application/json; charset=UTF-8;"},data:{characterId:c.owner,membershipType:b,itemId:c.id},dataType:"json",withCredentials:!0}}function C(a,b){b=_.sortBy(b,function(a){return"Exotic"===a.tier?1:0});var c=e.active,d={token:null,membershipType:null},f=g.bind(null,d,"token"),j=g.bind(null,d,"membershipType"),l=n.bind(null,c),m=k().then(f).then(l).then(j).then(function(){return{method:"POST",url:"https://www.bungie.net/Platform/Destiny/EquipItems/",headers:{"X-API-Key":F,"x-csrf":d.token,"content-type":"application/json; charset=UTF-8;"},data:{characterId:a.id,membershipType:c.type,itemIds:_.pluck(b,"id")},dataType:"json",withCredentials:!0}}).then(i).then(h).then(function(c){var d=c.data.Response;return a.updateCharacterInfo(d.summary),_.select(b,function(a){var b=_.find(d.equipResults,{itemInstanceId:a.id});return b&&1===b.equipStatus})});return m}function D(a,b,c){var d=e.active,f={token:null,membershipType:null},j=g.bind(null,f,"token"),l=g.bind(null,f,"membershipType"),m=n.bind(null,d),o=k().then(j).then(m).then(l).then(function(){return b}).then(function(b){return E(f.token,d.type,a,b,c)}).then(i).then(h);return o}function E(a,b,c,d,e){return{method:"POST",url:"https://www.bungie.net/Platform/Destiny/SetLockState/",headers:{"X-API-Key":F,"x-csrf":a,"content-type":"application/json; charset=UTF-8;"},data:{characterId:d.isVault?c.owner:d.id,membershipType:b,itemId:c.id,state:e},dataType:"json",withCredentials:!0}}var F="57c5ff5864634503a0340ffdfbeb20c0",G=null,H=null,I=null;a.$on("dim-active-platform-updated",function(a,b){G=null,H=null,I=null});var J={getPlatforms:l,getCharacters:o,getStores:s,transfer:x,equip:A,equipItems:C,setLockState:D,getXur:r};return J}angular.module("dimApp").factory("dimBungieService",a),a.$inject=["$rootScope","$q","$timeout","$http","dimState","toaster"]}(),function(a){"use strict";var b={Item:"items",ItemBucket:"buckets",Objective:"objectives",SandboxPerk:"perks",Stat:"stats",Talent:"talent",Years:"year1",Progression:"progression"},c=a.module("dimApp");_.each(b,function(a,b){var d=function(b){return b.get("scripts/api-manifest/"+a+".json?v=3.6.0").then(function(a){return a.data})["catch"](function(a){console.error(a)})};d.$inject=["$http"],c.factory("dim"+b+"Definitions",d)})}(angular),function(){"use strict";function a(a,b){return{show:function(c,d){function e(b){a.pop({type:"info",title:d.title,body:[b,'<input style="margin-top: 1px; vertical-align: middle;" id="info-'+c+'" type="checkbox">','<label for="info-'+c+'">'+d.hide+"</label></p>"].join(""),timeout:0,bodyOutputType:"trustedHtml",showCloseButton:!0,clickHandler:function(a,b,c,d,e,f,g){return!!b},onHideCallback:function(){if($("#info-"+c).is(":checked")){var a={};a["info."+c]=1,chrome.storage.sync.set(a,function(a){})}}})}d=d||{},d.title=d.title||"",d.body=d.body||"",d.hide=d.hide||"Hide This Popup",chrome.storage.sync.get("info."+c,function(a){(_.isNull(a)||_.isEmpty(a))&&(d.view?b.get(d.view).then(function(a){e(a.data)}):e(d.body))})}}}angular.module("dimApp").factory("dimInfoService",a),a.$inject=["toaster","$http"]}(),function(){"use strict";function a(a,b,c,d){function e(){
var a=c.getPlatforms().then(f);return a}function f(b){var c=b.data.Response;return j.splice(0),c.gamerTag&&j.push({id:c.gamerTag,type:1,label:"Xbox"}),c.psnId&&j.push({id:c.psnId,type:2,label:"PlayStation"}),a.$broadcast("dim-platforms-updated",{platforms:j}),g().then(function(a){i(a)}),j}function g(){var a=d.get("platformType").then(function(a){_.isUndefined(a)&&(a=null);var b=null,c=null;return _.isNull(a)||(b=_.find(j,function(b){return b.type===a})),c=_.size(j)>0?_.isNull(k)?b||j[0]:_.find(j,function(a){return a.id===k.id})?k:j[0]:null});return a}function h(){return k}function i(b){k=b;var c;c=_.isNull(b)?d.drop("platformType"):d.set("platformType",b.type),a.activePlatformUpdated=!0,a.$broadcast("dim-active-platform-updated",{platform:k})}var j=[],k=null,l={getPlatforms:e,getActive:h,setActive:i};return l}angular.module("dimApp").factory("dimPlatformService",a),a.$inject=["$rootScope","$q","dimBungieService","chromeStorage"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i){function j(a,c){b.$broadcast("dim-store-item-clicked",{item:a,clickEvent:c})}function k(a,b){if(a)if("v3.0"===b){var c=a["loadouts-v3.0"];w.splice(0),_.each(c,function(b){w.push(p(a[b]))})}else w.splice(0),a=_.filter(a,function(a){return!_.isNull(a)}),_.each(a,function(a){w.push(p(a))});else w=w.splice(0)}function l(b){var c=a.defer(),d=c.promise;return b||0===_.size(w)?chrome.storage.sync.get(null,function(a){_.has(a,"loadouts-v3.0")?k(a,"v3.0"):_.has(a,"loadouts-v2.0")?(k(a["loadouts-v2.0"],"v2.0"),m(w)):k(void 0),c.resolve(w)}):d=a.when(w),d.then(function(a){var b=h.getActive();return _.filter(a,function(a){return void 0===a.platform||a.platform===b.label})})}function m(b){var c,d=a.defer();return c=b?a.when(b):l(),c.then(function(a){w=a;var b=_.map(a,function(a){return v(a)}),c={"loadouts-v3.0":[]};return _.each(b,function(a){c["loadouts-v3.0"].push(a.id),c[a.id]=a}),chrome.storage.sync.set(c,function(a){d.resolve(b)}),d.promise})}function n(a){return l().then(function(b){var c=_.findIndex(b,function(b){return b.id===a.id});return c>=0&&b.splice(c,1),chrome.storage.sync.remove(a.id.toString(),function(){}),b}).then(function(a){return m(a)}).then(function(c){return b.$broadcast("dim-delete-loadout",{loadout:a}),c})}function o(a){return l().then(function(b){_.has(a,"id")||(a.id=c.newguid());var d=_.findIndex(b,{id:a.id});return d>-1?b[d]=a:b.push(a),m(b)}).then(function(c){return b.$broadcast("dim-save-loadout",{loadout:a}),c})}function p(a){var b={"v1.0":u,"v2.0":t,"v3.0":s,"default":s};return(b[a.version]||b["v1.0"])(a)}function q(b,c){i.queueAction(function(){var h=angular.copy(_.flatten(_.values(c.items))),i=h.length,j=h.map(function(a){return{id:a.id,hash:a.hash}});h=_.filter(h,function(a){var c=d.getItem(a);return!c||!c.equipment||c.owner!==b.id||c.equipped!==a.equipped});var k=_.filter(h,"equipped");k.length>1&&k.forEach(function(a){a.equipped=!1});var l=_.filter(h,function(a){var c=d.getItem(a);return c.owner!==b.id&&c.equipped}),m={failed:0,total:i,successfulItems:[]},n=a.when();if(l.length>1){var o=l.map(function(a){return d.getItem(a)}),p=_.map(_.groupBy(o,"owner"),function(a,b){var c=o.map(function(a){return d.getSimilarItem(a,j)});return d.equipItems(e.getStore(b),c)});n=a.all(p)}return n=n.then(function(){return r(b,h,c,j,m)}).then(function(){if(k.length>1){k=_.filter(k,function(a){return _.find(m.successfulItems,{id:a.id})});var a=k.map(function(a){return d.getItem(a)});return d.equipItems(b,a)}return k}).then(function(a){if(a.length<k.length){var b=_.filter(k,function(b){return!_.find(a,{id:b.id})});b.forEach(function(a){m.failed++,f.pop("error",c.name,"Could not equip "+a.name)})}}).then(function(){return m.successfulItems.length>0?e.updateCharacters():void 0}).then(function(){var a="success",d="Your loadout of "+m.total+" items has been transferred to your "+[b.race,b.gender,b["class"]].join(" ")+".";m.failed>0&&(m.failed===m.total?(a="error",d="None of the items in your loadout could be transferred."):(a="warning",d="Your loadout has been partially transferred, but "+m.failed+" of "+m.total+" items had errors.")),f.pop(a,c.name,d)}),g.addPromise(n),n})}function r(b,c,g,h,i){if(0==c.length)return a.when();var j=a.when(),k=c.shift(),l=d.getItem(k);if("Material"===l.type||"Consumable"===l.type){var m=k.amount-b.amountOfItem(k);if(m>0)for(var n=_.reject(e.getStores(),function(a){return b.id==a.id}),o=_.sortBy(n.map(function(a){return{store:a,amount:a.amountOfItem(k)}}),"amount").reverse();m>0;){var p=_.max(o,"amount"),q=Math.min(p.amount,m),s=_.findWhere(p.store.items,{hash:k.hash});if(0===q||!s){j=j.then(function(){return a.reject(new Error("There's not enough "+l.name+" to fulfill your loadout."))});break}p.amount-=q,m-=q,j=j.then(function(){return d.moveTo(s,b,!1,q)})}}else"Class"===l.type&&(l=_.findWhere(b.items,{hash:k.hash})),j=l?d.moveTo(l,b,k.equipped,l.amount,h):$.reject(new Error(l.name+" doesn't exist in your account."));return j=j.then(function(){i.successfulItems.push(l)})["catch"](function(a){i.failed++,f.pop("error",l.name,a.message)})["finally"](function(){return r(b,c,g,h,i)})}function s(a){var b={id:a.id,name:a.name,classType:_.isUndefined(a.classType)?-1:a.classType,version:"v3.0",items:{}};return _.each(a.items,function(a){var c=angular.copy(d.getItem({id:a.id,hash:a.hash}));if(c){var e=c.type.toLowerCase();c.equipped=a.equipped,c.amount=a.amount,b.items[e]=b.items[e]||[],b.items[e].push(c)}}),b}function t(a){var b={id:a.id,name:a.name,classType:_.isUndefined(a.classType)?-1:a.classType,version:"v3.0",items:{}};return _.each(a.items,function(a){var c=angular.copy(d.getItem({id:a.id,hash:a.hash}));if(c){var e=c.type.toLowerCase();c.equipped=a.equipped,b.items[e]=b.items[e]||[],b.items[e].push(c)}}),b}function u(a){var b={id:c.newguid(),name:a.name,classType:-1,version:"v3.0",items:{}};return _.each(a.items,function(a){var c=angular.copy(d.getItem(a));if(c){var e=c.type.toLowerCase();b.items[e]=b.items[e]||[],b.items[e].push(c),c.equipped=!0}}),b}function v(a){var b={id:a.id,name:a.name,classType:a.classType,version:"v3.0",platform:a.platform,items:[]};return b.items=_.chain(a.items).values().flatten().map(function(a){return{id:a.id,hash:a.hash,amount:a.amount,equipped:a.equipped}}).value(),b}var w=[];return{dialogOpen:!1,getLoadouts:l,deleteLoadout:n,saveLoadout:o,addItemToLoadout:j,applyLoadout:q,previousLoadouts:{}}}angular.module("dimApp").factory("dimLoadoutService",a),a.$inject=["$q","$rootScope","uuid2","dimItemService","dimStoreService","toaster","loadingTracker","dimPlatformService","dimActionQueue"]}(),function(){"use strict";function a(a,b){function c(){return h={hideFilteredItems:!1,itemDetails:!1,itemStat:!1,itemQuality:!1,showElements:!1,condensed:!1,characterOrder:"mostRecent",itemSort:"primaryStat",charCol:3,vaultCol:4},null!==i?a.when(i):a(function(a,b){function c(b){if(_.has(b,"settings-v1.0")){i=b["settings-v1.0"];var c=_.keys(i),d=_.keys(h),e=_.difference(d,c);e.forEach(function(a){i[a]=h[a]}),e.length>0&&g()}else i=angular.copy(h),g();a(i)}chrome.storage.sync.get(null,c)})}function d(){return c()}function e(b){return c().then(function(c){return b?_.has(c,b)?c[b]:a.reject("The key is not defined in the settings."):c})}function f(c,d){return e().then(function(e){e[c]=d;var f={"settings-v1.0":e},g={};return g[c]=d,a(function(a,c){chrome.storage.sync.set(f,function(d){chrome.runtime.lastError?c(chrome.runtime.lastError):(b.$apply(function(){b.$broadcast("dim-settings-updated",g)}),a(!0))})})})}function g(){return e().then(function(b){var c={"settings-v1.0":b};return a(function(a,b){chrome.storage.sync.set(c,function(c){chrome.runtime.lastError?b(chrome.runtime.lastError):a(!0)})})})}var h,i=null;return{getSetting:e,getSettings:d,saveSetting:f}}angular.module("dimApp").factory("dimSettingsService",a),a.$inject=["$q","$rootScope"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(){return c.getCharacters(e.getActive()).then(function(a){return _.each(J,function(b){if(!b.isVault){var c=_.findWhere(a,{id:b.id});b.updateCharacterInfo(c.base)}}),J})}function q(){setTimeout(r,0)}function r(){function a(a){var b=getComputedStyle(a),c=parseInt(b.height);return c}var b=function(b,c){var d=0;return _.each(c.children,function(b){var c=a(b);d=d>c?d:c}),d>b&&(b=d),b},c=function(a){var c=_.reduce(document.querySelectorAll(a),b,0),d=document.querySelectorAll("style[id="+a.replace(/\./g,"").replace(/\s/g,"")+"]");d.length>0?d=d[0]:(d=document.createElement("style"),d.type="text/css",d.id=a.replace(/\./g,"").replace(/\s/g,""),document.getElementsByTagName("head")[0].appendChild(d)),d.innerHTML=a+" { min-height: "+c+"px; }"};c(".sub-section.sort-class"),c(".sub-section.sort-primary"),c(".sub-section.sort-special"),c(".sub-section.sort-heavy"),c(".sub-section.sort-helmet"),c(".sub-section.sort-chest"),c(".sub-section.sort-gauntlets"),c(".sub-section.sort-leg"),c(".sub-section.sort-classitem"),c(".sub-section.sort-artifact"),c(".sub-section.sort-emblem"),c(".sub-section.sort-shader"),c(".sub-section.sort-ghost"),c(".sub-section.sort-emote"),c(".sub-section.sort-ship"),c(".sub-section.sort-vehicle"),c(".sub-section.sort-horn"),c(".sub-section.sort-consumable"),c(".sub-section.sort-material"),c(".sub-section.sort-missions"),c(".sub-section.sort-bounties"),c(".sub-section.sort-messages"),c(".sub-section.sort-special-orders"),c(".sub-section.sort-lost-items"),c(".sub-section.sort-quests"),c(".sub-section.sort-unknown"),c(".weapons"),c(".armor"),c(".general")}function s(a){return d.getSetting("characterOrder").then(function(b){return"mostRecent"===b?_.sortBy(a,"lastPlayed").reverse():_.sortBy(a,"id")})}function t(){return J}function u(){return c.getStores(e.getActive()).then(function(a){var c,d;return b.all(a.map(function(a){var b,e=[];if(a){if("vault"===a.id)b=angular.extend(Object.create(S),{id:"vault",name:"vault",lastPlayed:"2005-01-01T12:00:01Z",icon:"",items:[],legendaryMarks:d,glimmer:c,bucketCounts:{},isVault:!0,capacityForItem:function(a){if(!a.sort)throw new Error("item needs a 'sort' field");return K[a.sort]},spaceLeftForItem:function(a){if(!a.sort)throw new Error("item needs a 'sort' field");return Math.max(0,this.capacityForItem(a)-count(this.items,{sort:a.sort}))}}),_.each(a.data.buckets,function(a){3003523923===a.bucketHash&&(b.bucketCounts.Armor=_.size(a.items)),138197802===a.bucketHash&&(b.bucketCounts.General=_.size(a.items)),4046403665===a.bucketHash&&(b.bucketCounts.Weapons=_.size(a.items)),_.each(a.items,function(b){b.bucket=a.bucketHash}),e=_.union(e,a.items)});else{try{c=_.find(a.character.base.inventory.currencies,function(a){return 3159615086===a.itemHash}).value,d=_.find(a.character.base.inventory.currencies,function(a){return 2534352370===a.itemHash}).value}catch(f){c=0,d=0}b=angular.extend(Object.create(S),{id:a.id,icon:a.character.base.emblemPath,lastPlayed:a.character.base.characterBase.dateLastPlayed,background:a.character.base.backgroundPath,level:a.character.base.characterLevel,powerLevel:a.character.base.characterBase.powerLevel,stats:I(a.character.base.characterBase),"class":E(a.character.base.characterBase.classType),gender:G(a.character.base.characterBase.genderType),race:F(a.character.base.characterBase.raceHash),percentToNextLevel:a.character.base.percentToNextLevel,isVault:!1}),b.name=b["class"],_.each(a.data.buckets,function(a){_.each(a,function(a){_.each(a.items,function(b){b.bucket=a.bucketHash}),e=_.union(e,a.items)})}),_.has(a.character.base.inventory.buckets,"Invisible")&&_.size(a.character.base.inventory.buckets.Invisible)>0&&_.each(a.character.base.inventory.buckets.Invisible,function(a){e=_.union(e,a.items)})}return D(b.id,e).then(function(a){return b.items=a,b})}}))}).then(function(a){return s(a)}).then(function(b){return J=b,a.$broadcast("dim-stores-updated",{stores:b}),q(),b})}function v(a){return _.find(J,{id:a})}function w(a){var b=a.hash+"-";return"0"===a.id?(b+=a.amount,V[b]=(V[b]||0)+1,b=b+"-"+V[b]):b+=a.id,b}function x(a,b,c,d,e,f,h,i,j){var k=a[j.itemHash];if(k&&"Classified"!==k.itemName||(k={classified:!0,icon:"/img/misc/missing_icon.png"},194424271===j.itemHash&&(q="Armor Shader",k.bucketTypeHash=2973005342,k.classType=3,k.itemTypeName="Armor Shader",k.description="",k.itemName="Walkabout - Classified",k.nonTransferrable=!0,k.equipRequiredLevel=0,k.equipment=!0,j.isEquipment=!0),1963806104===j.itemHash&&(q="Mystery Bag",k.bucketTypeHash=1469714392,k.icon="/common/destiny_content/icons/3651da8a8b0add3161e840c7104078ed.jpg",k.classType=3,k.itemTypeName=q,k.description="Contains 1 Guaranteed Item and up to 4 Possible Items. This item is nonreturnable.",k.itemName="Sterling Treasure",k.maxStackSize=99,k.nonTransferrable=!0,k.equipRequiredLevel=0,k.equipment=!1,j.isEquipment=!1),k.itemName||(console.warn("Missing Item Definition:\n\n",j,"\n\nplease contact a developer to get this item added."),window.onerror("Missing Item Definition - "+JSON.stringify(_.pick(j,"canEquip","cannotEquipReason","equipRequiredLevel","isEquipment","itemHash","location","stackSize","talentGridHash")),"dimStoreService.factory.js",491,11))),!k.itemTypeName||!k.itemName)return null;var l,m=b[k.bucketTypeHash],n=b[j.bucket];n&&Q[n.bucketIdentifier]&&(l=Q[n.bucketIdentifier]);var o;m&&Q[m.bucketIdentifier]&&(o=Q[m.bucketIdentifier]);var p=null;g.Weapons.indexOf(o)>=0&&(p=k.itemTypeName.toLowerCase().replace(/\s/g,""));var q=l||o||"Unknown",r=R[q];r||console.log(k.itemTypeName+" does not have a sort property."),"Postmaster"!==r&&4===j.location&&(r="Postmaster",q="Consumable"===q?"Special Orders":"Lost Items");var s=[null,"kinetic","arc","solar","void"][j.damageType],t=angular.extend(Object.create(T),{hash:j.itemHash,type:q,sort:r,tier:k.tierTypeName||"Common",name:k.itemName,description:k.itemDescription||"",icon:k.icon,notransfer:"Postmaster"===r||k.nonTransferrable,id:j.itemInstanceId,equipped:j.isEquipped,bucket:k.bucketTypeHash,equipment:j.isEquipment,complete:j.isGridComplete,percentComplete:null,amount:j.stackSize,primStat:j.primaryStat,typeName:k.itemTypeName,equipRequiredLevel:j.equipRequiredLevel,maxStackSize:k.maxStackSize>0?k.maxStackSize:1,classType:k.classType,classTypeName:E(k.classType),dmg:s,visible:!0,year:h.year1.indexOf(j.itemHash)>=0?1:2,lockable:j.lockable,locked:j.locked,weaponClass:p||"",classified:k.classified});t.index=w(t);try{t.talentGrid=y(j,f,i,e)}catch(u){console.error("Error building talent grid for "+t.name,j,k)}try{t.stats=C(j,k,c,t.talentGrid,q)}catch(u){console.error("Error building stats for "+t.name,j,k)}try{t.objectives=z(j,d,k)}catch(u){console.error("Error building objectives for "+t.name,j,k)}if(t.talentGrid&&t.talentGrid.infusable)try{t.quality=A(t.stats,j.primaryStat,q)}catch(u){console.error("Error building quality rating for "+t.name,j,k)}return t.objectives?(t.complete=(!t.talentGrid||t.complete)&&_.all(t.objectives,"complete"),t.percentComplete=Math.floor(100*sum(t.objectives,function(a){return Math.min(1,a.progress/a.completionValue)/t.objectives.length}))):t.talentGrid&&(t.percentComplete=Math.floor(100*Math.min(1,t.talentGrid.totalXP/t.talentGrid.totalXPRequired))),t}function y(a,b,c,d){function e(a){if(0===a)return 0;for(var b=0,c=1;a>=c;c++)b+=i[Math.min(c,i.length)-1];return b}var f=b[a.talentGridHash];if(a.progression&&f){var g=a.progression.currentProgress,h=a.progression.level,i=c[a.progression.progressionHash].steps,j=f.nodes,k=a.nodes.map(function(b){var c=j[b.nodeHash],d=c.steps[b.stepIndex],f=d.nodeStepName;if(f&&0!==f.length&&!(c.column<0)){var i=!!(c.exlusiveWithNodes&&c.exlusiveWithNodes.length>0),k=b.isActivated||c.autoUnlocks||i&&_.any(c.exlusiveWithNodes,function(b){return a.nodes[b].isActivated}),l=d.startProgressionBarAtProgress,m=d.activationRequirement.gridLevel,n=e(m)-l,o=Math.max(0,Math.min(g-l,n));return{name:f,hash:d.nodeStepHash,description:d.nodeStepDescription,icon:d.icon,xp:o,xpRequired:n,column:c.column,row:c.row,activated:b.isActivated,activatedAtGridLevel:m,exclusiveInColumn:i,xpRequirementMet:h>=m,unlocked:k,hidden:b.hidden}}});k=_.compact(k);var l=_.max(k,"activatedAtGridLevel").activatedAtGridLevel,m=e(l),n=_.find(k,{name:"Ascend"}),o=_.min(k,"column").column;return o>0&&k.forEach(function(a){a.column-=o}),{nodes:_.sortBy(k,function(a){return a.column+.1*a.row}),xpComplete:g>=m,totalXPRequired:m,totalXP:Math.min(m,g),hasAscendNode:!!n,ascended:!(!n||!n.activated),infusable:_.any(k,{name:"Infuse"})}}}function z(a,b,c){return a.objectives&&a.objectives.length?a.objectives.map(function(a){var c=b[a.objectiveHash];return{description:c.displayDescription,progress:a.progress,completionValue:c.completionValue,complete:a.isComplete,"boolean":1===c.completionValue}}):void 0}function A(a,b,c){var d=335;if(!a||b.value<280)return null;var e=0,f=0;switch(c.toLowerCase()){case"helmet":f=1/6,e=46;break;case"gauntlets":f=1/6,e=41;break;case"chest":f=.2,e=61;break;case"leg":f=.2,e=56;break;case"classitem":case"ghost":f=.1,e=25;break;case"artifact":f=.1,e=38;break;default:return null}var g={total:0,max:2*e},h=0;return a.forEach(function(a){var c=0;a.base&&(c=Math.floor(f*(d-b.value)+a.base),h=c),a.scaled=c,a.split=e,g.total+=c||0}),h===g.total&&a.forEach(function(a){a.scaled=Math.floor(a.scaled/2)}),Math.round(g.total/g.max*100)}function B(a,b){switch(b.toLowerCase()){case"helmet":case"helmets":return 292>a?15:307>a?16:319>a?17:332>a?18:19;case"gauntlets":return 287>a?13:305>a?14:319>a?15:333>a?16:17;case"chest":case"chest armor":return 287>a?20:300>a?21:310>a?22:319>a?23:328>a?24:25;case"leg":case"leg armor":return 284>a?18:298>a?19:309>a?20:319>a?21:329>a?22:23;case"classitem":case"class items":case"ghost":case"ghosts":return 295>a?8:319>a?9:10;case"artifact":case"artifacts":return 287>a?34:295>a?35:302>a?36:308>a?37:314>a?38:319>a?39:325>a?40:330>a?41:42;case"lost items":return 0}return console.warn("item bonus not found",b),0}function C(a,b,c,d,e){if(a.stats&&a.stats.length&&b.stats){var f,g=[];return d&&d.nodes&&3897883278===a.primaryStat.statHash&&(g=_.filter(d.nodes,function(a){return _.contains(["Increase Intellect","Increase Discipline","Increase Strength"],a.name)}),g&&(f=_.findWhere(g,{activated:!0})||{hash:0})),_.sortBy(_.compact(_.map(b.stats,function(b){var d=c[b.statHash];if(d){var h=d.statName;"Aim assistance"===h&&(h="Aim Assist");var i,j=["Aim Assist","Equip Speed"],k=-1,l=_.findIndex(a.stats,{statHash:b.statHash});if(0>l?(k=j.indexOf(h),l=50+k):(i=a.stats[l],"Magazine"!==h&&"Energy"!==h||(l=100)),i||!(0>k)){var m=100;i&&i.maximumValue&&(m=i.maximumValue);var n=i?i.value:b.value,o=n,p=0;return 3897883278===a.primaryStat.statHash&&("Intellect"===h&&_.find(g,{name:"Increase Intellect"})||"Discipline"===h&&_.find(g,{name:"Increase Discipline"})||"Strength"===h&&_.find(g,{name:"Increase Strength"}))&&(p=B(a.primaryStat.value,e),(f&&"Intellect"===h&&"Increase Intellect"===f.name||"Discipline"===h&&"Increase Discipline"===f.name||"Strength"===h&&"Increase Strength"===f.name)&&(o=Math.max(0,n-p))),{base:o,bonus:p,statHash:b.statHash,name:h,sort:l,value:n,maximumValue:m,bar:"Magazine"!==h&&"Energy"!==h}}}})),"sort")}}function D(a,c){return V={},b.all([h,i,j,k,m,l,n,o]).then(function(b){var d=[];return _.each(c,function(c){var e=null;try{e=x.apply(void 0,b.concat(c))}catch(f){console.error("Error processing item",c,f)}null!==e&&(e.owner=a,d.push(e))}),d})}function E(a){switch(a){case 0:return"titan";case 1:return"hunter";case 2:return"warlock"}return"unknown"}function F(a){switch(a){case 3887404748:return"human";case 898834093:return"exo";case 2803282938:return"awoken"}return"unknown"}function G(a){switch(a){case 0:return"male";case 1:return"female"}return"unknown"}function H(a,b,c){if("STAT_INTELLECT"===b)switch(a){case 2007186e3:case 4143670656:case 2455559914:case 3658182170:return M[c];default:return N[c]}else{if("STAT_DISCIPLINE"===b)return O[c];if("STAT_STRENGTH"!==b)return"-:--";switch(a){case 4143670656:case 1716862031:return P[c];default:return O[c]}}}function I(a){for(var b=["STAT_INTELLECT","STAT_DISCIPLINE","STAT_STRENGTH"],c=["STAT_INTELLECT","STAT_DISCIPLINE","STAT_STRENGTH","STAT_ARMOR","STAT_RECOVERY","STAT_AGILITY"],d={},e=0;e<c.length;e++){var f={};switch(c[e]){case"STAT_INTELLECT":f.name="Intellect",f.effect="Super";break;case"STAT_DISCIPLINE":f.name="Discipline",f.effect="Grenade";break;case"STAT_STRENGTH":f.name="Strength",f.effect="Melee"}if(a.stats[c[e]]){if(f.value=a.stats[c[e]].value,b.indexOf(c[e])>-1){f.normalized=f.value>300?300:f.value,f.tier=Math.floor(f.normalized/60),f.tiers=[],f.remaining=f.value;for(var g=0;5>g;g++)f.remaining-=f.tiers[g]=f.remaining>60?60:f.remaining;a.peerView&&(f.cooldown=H(a.peerView.equipment[0].itemHash,c[e],f.tier)),f.percentage=+(100*f.normalized/300).toFixed()}else f.percentage=+(100*f.value/10).toFixed();d[c[e]]=f}}return d}var J=[],K={},L={};i.then(function(a){_.each(a,function(a,b){a.enabled&&(L[b]=a.itemCount)}),K.Weapons=L[4046403665],K.Armor=L[3003523923],K.General=L[138197802]});var M=["5:00","4:46","4:31","4:15","3:58","3:40"],N=["5:30","5:14","4:57","4:39","4:20","4:00"],O=["1:00","0:55","0:49","0:42","0:34","0:25"],P=["1:10","1:04","0:57","0:49","0:40","0:29"],Q={BUCKET_CHEST:"Chest",BUCKET_LEGS:"Leg",BUCKET_RECOVERY:"Lost Items",BUCKET_SHIP:"Ship",BUCKET_MISSION:"Missions",BUCKET_ARTIFACT:"Artifact",BUCKET_HEAVY_WEAPON:"Heavy",BUCKET_COMMERCIALIZATION:"Special Orders",BUCKET_CONSUMABLES:"Consumable",BUCKET_PRIMARY_WEAPON:"Primary",BUCKET_CLASS_ITEMS:"ClassItem",BUCKET_QUESTS:"Quests",BUCKET_VEHICLE:"Vehicle",BUCKET_BOUNTIES:"Bounties",BUCKET_SPECIAL_WEAPON:"Special",BUCKET_SHADER:"Shader",BUCKET_EMOTES:"Emote",BUCKET_MAIL:"Messages",BUCKET_BUILD:"Class",BUCKET_HEAD:"Helmet",BUCKET_ARMS:"Gauntlets",BUCKET_HORN:"Horn",BUCKET_MATERIALS:"Material",BUCKET_GHOST:"Ghost",BUCKET_EMBLEM:"Emblem"},R={};_.each(g,function(a,b){a.forEach(function(a){R[a]=b})});var S={amountOfItem:function(a){return sum(_.filter(this.items,function(b){return b.hash===a.hash&&"Postmaster"!==b.sort}),"amount")},capacityForItem:function(a){return a.bucket||console.error("item needs a 'bucket' field",a),L[a.bucket]||10},spaceLeftForItem:function(a){if(!a.type)throw new Error("item needs a 'type' field");return Math.max(0,this.capacityForItem(a)-count(this.items,{type:a.type}))},updateCharacterInfo:function(a){this.level=a.characterLevel,this.percentToNextLevel=a.percentToNextLevel,this.powerLevel=a.characterBase.powerLevel,this.background=a.backgroundPath,this.icon=a.emblemPath,this.stats=I(a.characterBase)}},T={canBeEquippedBy:function(a){return a.isVault?!1:this.equipment&&("unknown"===this.classTypeName||this.classTypeName===a["class"])&&this.equipRequiredLevel<=a.level&&(!this.notransfer||this.owner===a.id)&&"Postmaster"!==this.sort},isEngram:function(){return!this.equipment&&this.typeName.toLowerCase().indexOf("engram")>=0}},U={getStores:t,reloadStores:u,getStore:v,getStatsData:I,getBonus:B,getVault:v.bind(null,"vault"),updateCharacters:p,setHeights:q,createItemIndex:w,processItems:D};return a.$on("dim-settings-updated",function(a){_.has(a,"characterOrder")&&s(J).then(function(a){J=a})}),U;var V}angular.module("dimApp").factory("dimStoreService",a),a.$inject=["$rootScope","$q","dimBungieService","dimSettingsService","dimPlatformService","dimItemTier","dimCategory","dimItemDefinitions","dimItemBucketDefinitions","dimStatDefinitions","dimObjectiveDefinitions","dimTalentDefinitions","dimSandboxPerkDefinitions","dimYearsDefinitions","dimProgressionDefinitions"]}(),function(){"use strict";function a(a,b,c,d,e,f){function g(){return f.get("scripts/xur/xur.json").then(function(a){return a.data.Response.data})}var h=!1;return{available:!1,itemCategories:{},updateXur:function(){var a=this,b=h?g():c.getXur();return b.then(function(b){a.available=b&&b.enabled&&b.saleItemCategories,a.available&&d.then(function(c){a.itemCategories={};var d=[];return b.saleItemCategories.forEach(function(b){var e=b.saleItems.map(function(a){return d.push(a.item),{cost:a.costs[0].value,currency:_.pick(c[a.costs[0].itemHash],"itemName","icon","itemHash"),itemHash:a.item.itemHash}});a.itemCategories[b.categoryTitle]=e}),e.processItems(null,d).then(function(b){var c=_.indexBy(b,"hash");_.each(a.itemCategories,function(a,b){a.forEach(function(a){a.item=c[a.itemHash],delete a.itemHash})})})})})}}}angular.module("dimApp").factory("dimXurService",a),a.$inject=["$rootScope","$q","dimBungieService","dimItemDefinitions","dimStoreService","$http"]}(),function(){"use strict";function a(a,b,c,d,e){function f(a,c,d){return b.setLockState(a,c,d).then(function(){return d})}function g(b,c,d,e,f){if(c=a.getStore(c.id),d=a.getStore(d.id),b=x(b),c.id!==d.id){for(var g=b.maxStackSize>1,h=g?_.sortBy(_.select(c.items,function(a){return a.hash===b.hash&&a.id===b.id&&!a.notransfer}),"amount"):[b],i=g?_.sortBy(_.select(d.items,function(a){return a.hash===b.hash&&a.id===b.id&&a.amount!==a.maxStackSize&&!a.notransfer}),"amount"):[],j=f||b.amount,k=j,l=j,m=!1;l>0;){var n=h.shift();if(!n)throw new Error("Looks like you requested to move more of this item than exists in the source!");var o=Math.min(l,n.amount);if(o===n.amount){var p=_.findIndex(c.items,function(a){return n.index===a.index});p>=0&&(c.items.splice(p,1),m=n.index===b.index)}else n.amount-=o;l-=o}for(var q;k>0;){q=i.shift(),q||(q=b,m||(q=angular.copy(b),q.index=a.createItemIndex(q)),m=!1,q.amount=0,d.items.push(q),q.owner=d.id);var r=Math.min(k,q.maxStackSize-q.amount);q.amount+=r,k-=r}b=q}if(e){var s=_.findWhere(d.items,{equipped:!0,type:b.type});s.equipped=!1,b.equipped=!0}return b}function h(b,c){var d=a.getStore(b.owner),e=_.sortBy(a.getStores(),function(a){return d.id===a.id?0:a.isVault?1:2}),f=null;return e.find(function(a){return f=i(b,a,c,d),null!==f}),f}function i(a,b,d,e){d=d||[];var f=_.filter(b.items,function(b){return b.canBeEquippedBy(e)&&b.type===a.type&&!b.equipped&&b.id!==a.id&&!_.any(d,{id:b.id,hash:b.hash})});if(!f.length)return null;var g=_.max(f,function(a){var b={Legendary:4,Rare:3,Uncommon:2,Common:1,Exotic:0}[a.tier];return a.primStat&&(b+=a.primStat.value/1e3),b});if(g&&g.tier===c.exotic){var h=_.filter(b.items,function(b){return b.equipped&&b.sort===a.sort&&b.tier===c.exotic});return 0===h.length?g:null}return g||null}function j(a,c){return b.equipItems(a,c).then(function(b){return b.map(function(b){return g(b,a,a,!0)})})}function k(c){return b.equip(c).then(function(){var b=a.getStore(c.owner);return g(c,b,b,!0)})}function l(b){var c=h(b),d=a.getStore(b.owner),f=a.getStore(c.owner),g=e.when();return d.id!==f.id&&(g=v(c,d,!0)),g.then(function(){return k(c)})}function m(b,c){return n(b,a.getVault(),!1,c)}function n(c,d,e,f){return b.transfer(c,d,f).then(function(){var b=a.getStore(c.owner),h=g(c,b,d,!1,f);return"vault"!==h.owner&&e?k(h):h})}function o(a,b){function c(a){return void 0!==_.find(a.talentGrid.nodes,{name:"The Life Exotic"})}var d=e.defer(),f=d.promise,g=_.filter(b.items,function(b){return b.equipped&&b.type!==a.type&&b.sort===a.sort&&"Exotic"===b.tier});if(0===g.length)d.resolve(!0);else if(1===g.length){var h=g[0];c(a)||c(h)?d.resolve(!0):l(h).then(function(a){d.resolve(!0)})["catch"](function(b){d.reject(new Error("'"+a.name+"' cannot be equipped because the exotic in the "+h.type+" slot cannot be unequipped."))})}else if(2===g.length)if(c(a)){var i=_.find(g,c(a));l(i).then(function(a){d.resolve(!0)})["catch"](function(b){d.reject(new Error("'"+a.name+"' cannot be equipped because the exotic in the "+h.type+" slot cannot be unequipped."))})}else{var j=_.find(g,function(a){return!c(a)});l(j).then(function(a){d.resolve(!0)})["catch"](function(b){d.reject(new Error("'"+a.name+"' cannot be equipped because the exotic in the "+h.type+" slot cannot be unequipped."))})}return f}function p(b,c,e){var f,g=a.getStores();if(b.isVault&&!_.any(g,function(a){return e.spaceLeft(a,c)})){var h=_.max(d[c.sort],function(a){return _.max(g.map(function(c){if(c.id===b.id)return 0;var d=_.find(b.items,{type:a});return d?e.spaceLeft(c,d):0}))});f=_.filter(b.items,{type:h})}else f=_.filter(b.items,{type:c.type});if(f=_.reject(f,function(a){return a.notransfer||_.any(e.excludes,{id:a.id,hash:a.hash})}),0===f.length)throw new Error("There's nothing we can move aside to make room for "+c.name);var i=_[b.isVault?"max":"min"](f,function(a){var c=a.equipped?10:0;return c+={Common:0,Uncommon:1,Rare:2,Legendary:3,Exotic:4}[a.tier],!b.isVault&&a.canBeEquippedBy(b)&&(c+=5),a.primStat&&(c+=a.primStat.value/1e3),c});return i}function q(b,c,d){var e,f=a.getStores();if(b.isVault)e=_.max(_.reject(f,"isVault"),function(a){return d.spaceLeft(a,c)});else{var g=a.getVault();e=d.spaceLeft(g,c)>0?g:_.max(f,function(a){return d.spaceLeft(a,c)}),d.spaceLeft(e,c)<=0&&(e=g)}return e===-(1/0)?void 0:e}function r(a,b){var c=0;if(b.maxStackSize>1){var d=a.amountOfItem(b);c=Math.ceil((d+b.amount)/b.maxStackSize)-Math.ceil(d/b.maxStackSize)}else c=1;return c}function s(b,c,d,f){if(b.owner===c.id)return e.resolve(!0);var g=a.getStores(),h={};g.forEach(function(a){h[a.id]=a.id===c.id?r(a,b):0}),"vault"===b.owner||c.isVault||(h.vault=r(a.getVault(),b));var i={};if(a.getStores().forEach(function(a){i[a.id]=Math.max(0,h[a.id]-a.spaceLeftForItem(b))}),_.any(i)){if(c.isVault||d){var j={reservations:h,originalItemType:b.type,excludes:f||[],spaceLeft:function(a,b){var c=a.spaceLeftForItem(b);return b.type===this.originalItemType&&(c-=this.reservations[a.id]),Math.max(0,c)}},k=_.pairs(i).reverse().find(function(a){return a[1]>0}),l=a.getStore(k[0]),m=p(l,b,j),n=q(l,m,j);return!n||!n.isVault&&n.spaceLeftForItem(m)<=0?e.reject(new Error("There are too many '"+(n.isVault?m.sort:m.type)+"' items in the "+n.name+".")):v(m,n,!1,m.amount,f).then(function(){return s(b,c,d,f)})}var o=y()||e.when(a.getStores());return o.then(function(a){return c=_.find(a,{id:c.id}),s(b,c,!0,f)})}return e.resolve(!0)}function t(a,b){return e(function(c,d){a.canBeEquippedBy(b)?c(!0):d(new Error("This can only be equipped on "+a.classTypeName+"s at or above level "+a.equipRequiredLevel+"."))})}function u(a,b,c,d){var f=[];return f.push(s(c,b,!1,d)),a&&f.push(t(c,b)),"Exotic"===c.tier&&a&&f.push(o(c,b)),e.all(f)}function v(b,c,d,f,g){var h={item:b,source:a.getStore(b.owner),target:c,isVault:{source:"vault"===b.owner,target:c.isVault}},i=u(d,c,b,g).then(function(b){h.target=a.getStore(c.id)}).then(function(a){var c=e.when(b);return h.isVault.source||h.isVault.target?h.isVault.source&&h.isVault.target||(h.isVault.source||h.isVault.target)&&(b.equipped&&(c=c.then(function(){return l(b)})),c=c.then(function(){return n(b,h.target,d,f)})):(h.source.id!=h.target.id&&(b.equipped&&(c=c.then(function(){return l(b)})),c=c.then(function(){return m(b,f)}).then(function(a){return n(a,h.target,d,f)})),d?c=c.then(function(){return b.equipped?e.when(b):k(b)}):d||(c=c.then(function(){return b.equipped?l(b):e.when(b)}))),c});return i}function w(){var b=[];return a.getStores().forEach(function(a){b=b.concat(a.items)}),b}function x(a,b){var c=b?b.items:w();return _.findWhere(c,_.pick(a,"id","hash","notransfer"))}var y=_.throttle(function(){return a.reloadStores()},1e4,{trailing:!1});return{getSimilarItem:h,getItem:x,getItems:w,moveTo:v,equipItems:j,setLockState:f}}angular.module("dimApp").factory("dimItemService",a),a.$inject=["dimStoreService","dimBungieService","dimItemTier","dimCategory","$q"]}(),function(){"use strict";function a(a,b,c,d,e,f,g){var h,i;return{active:!1,store:null,engramsMoved:0,movingEngrams:!1,makingRoom:!1,moveItemsToVault:function(a,e){var h=this,i="No space left!";return _.reduce(a,function(j,k){return j.then(function(){var e=d.getVault(),g=e.spaceLeftForItem(k);if(1>=g){var j=_.select(d.getStores(),function(a){return!a.isVault&&a.id!==h.store.id}),l=_.select(j,function(a){return a.spaceLeftForItem(k)>0});if(l.length)return c.moveTo(k,l[0],!1,k.amount,a);if(0===g&&!_.any(j,function(a){return _.any(f[k.sort],function(b){return a.spaceLeftForItem({type:b})>0})}))return b.reject(new Error(i))}return c.moveTo(k,e,!1,k.amount,a)}).then(function(){e&&h.engramsMoved++})["catch"](function(a){a.message!==i&&g.pop("error",k.name,a.message)})},b.resolve())},moveEngramsToVault:function(){
var a=this,c=d.getStore(a.store.id),e=_.select(c.items,function(a){return a.isEngram()&&"Postmaster"!==a.sort});return 0===e.length?b.resolve():(a.movingEngrams=!0,a.moveItemsToVault(e,!0)["finally"](function(){a.movingEngrams=!1}))},makeRoomForEngrams:function(){var a=this,c=d.getStore(a.store.id),e=["Primary","Special","Heavy","Helmet","Gauntlets","Chest","Leg","ClassItem"],f=_.select(c.items,function(a){return!a.equipped&&"Postmaster"!==a.sort&&_.contains(e,a.type)}),g=_.groupBy(f,"type"),h=[];return _.each(g,function(a,b){a.length>0&&a.length>=c.capacityForItem(a[0])-1&&h.push(_.min(_.select(a,{notransfer:!1}),function(a){var b={Common:0,Uncommon:1,Rare:2,Legendary:3,Exotic:4}[a.tier];return a.primStat&&(b+=a.primStat.value/1e3),b}))}),0===h.length?b.resolve():(a.makingRoom=!0,a.moveItemsToVault(h,!1)["finally"](function(){a.makingRoom=!1}))},start:function(b){function c(){f.moveEngramsToVault().then(function(){f.makeRoomForEngrams()})}if(!this.active){this.active=!0,this.store=b,this.engramsMoved=0,this.movingEngrams=!1,this.makingRoom=!1;var f=this;i=a.$on("dim-stores-updated",function(){!f.active||f.movingEngrams||f.makingRoom||c()}),h=e(function(){d.reloadStores()},6e4),c()}},stop:function(){h&&e.cancel(h),i&&i(),this.active=!1}}}angular.module("dimApp").factory("dimEngramFarmingService",a),a.$inject=["$rootScope","$q","dimItemService","dimStoreService","$interval","dimCategory","toaster"]}(),function(){"use strict";function a(a){function c(b,c,d){var e=b.vm;e.classTypeValues=[{label:"Any",value:-1},{label:"Warlock",value:0},{label:"Titan",value:1},{label:"Hunter",value:2}],e.classList={"loadout-create":!0},b.$on("dim-create-new-loadout",function(b,c){e.show=!0,a.dialogOpen=!0}),b.$on("dim-delete-loadout",function(b,c){e.show=!1,a.dialogOpen=!1,e.loadout=angular.copy(e.defaults)}),b.$on("dim-edit-loadout",function(b,c){c.loadout&&(e.show=!0,a.dialogOpen=!0,e.loadout=angular.copy(c.loadout))}),b.$on("dim-store-item-clicked",function(a,b){e.add(b.item,b.clickEvent)})}return{controller:b,controllerAs:"vm",bindToController:!0,link:c,scope:{},template:['<div id="loadout-drawer" ng-class="vm.classList" ng-if="vm.show">','  <div ng-messages="vm.form.name.$error" ng-if="vm.form.$submitted || vm.form.name.$touched">','    <div ng-message="required">A name is required.</div>','    <div ng-message="minlength">...</div>','    <div ng-message="maxlength">...</div>',"  </div>",'  <div class="loadout-content">','    <div id="loadout-options">','      <form name="vm.form">','        <input name="name" ng-model="vm.loadout.name" minlength="1" maxlength="50" required type="search" placeholder="Loadout Name..." />','        <select name="classType" ng-model="vm.loadout.classType" ng-options="item.value as item.label for item in vm.classTypeValues"></select>','        <input type="button" ng-disabled="vm.form.$invalid" value="Save" ng-click="vm.save()"></input>','        <input type="button" ng-disabled="vm.form.$invalid || !vm.loadout.id" value="Save as New" ng-click="vm.saveAsNew()"></input>','        <input type="button" ng-click="vm.cancel()" value="Cancel"></input>','        <span>Items with the <img src="images/spartan.png" style="border: 1px solid #333; background-color: #f00; margin: 0 2px; width: 16px; height: 16px;  vertical-align: text-bottom;"> icon will be equipped.  Click on an item toggle equip.</span>','        <p id="loadout-error"></p>',"      </form>","    </div>",'    <div id="loadout-contents">','      <div ng-repeat="value in vm.types track by value" class="loadout-{{ value }} loadout-bucket" ng-if="vm.loadout.items[value].length">','        <div ng-repeat="item in vm.loadout.items[value] | sortItems:vm.itemSort track by item.index" ng-click="vm.equip(item)" id="loadout-item-{{:: $id }}" class="loadout-item">','          <dim-simple-item item-data="item"></dim-simple-item>','          <div class="close" ng-click="vm.remove(item, $event); vm.form.name.$rollbackViewValue(); $event.stopPropagation();"></div>','          <div class="equipped" ng-show="item.equipped"></div>',"        </div>","      </div>","    </div>","  </div>","</div>"].join("")}}function b(a,b,c,d,e,f,g){var h=this;h.types=_.chain(b).values().flatten().map(function(a){return a.toLowerCase()}).value(),h.show=!1,a.dialogOpen=!1,h.defaults={classType:-1,items:{}},h.loadout=angular.copy(h.defaults),h.save=function(){var b=e.getActive();h.loadout.platform=b.label,a.saveLoadout(h.loadout),h.cancel()},h.saveAsNew=function(){delete h.loadout.id,h.save()},h.cancel=function(){h.loadout=angular.copy(h.defaults),a.dialogOpen=!1,h.show=!1},h.add=function(a,b){if(a.equipment||"Material"===a.type||"Consumable"===a.type){var c=angular.copy(a),e=c.type.toLowerCase(),f=h.loadout.items[e]=h.loadout.items[e]||[];c.amount=Math.min(c.amount,b.shiftKey?5:1);var g=_.findWhere(f,{hash:c.hash,id:c.id}),i=10;if("Material"===a.type?i=20:"Consumable"===a.type&&(i=19),g){if(g&&c.maxStackSize>1){var j=Math.min(g.amount+c.amount,g.maxStackSize)-g.amount;g.amount+=j}}else f.length<i?(c.equipped=a.equipment&&0===f.length,"Class"===c.type&&_.has(h.loadout.items,"class")&&(h.loadout.items["class"].splice(0,h.loadout.items["class"].length),c.equipped=!0),f.push(c)):d.pop("warning","","You can only have "+i+" of that kind of item in a loadout.")}else d.pop("warning","","Only equippable items, materials, and consumables can be added to a loadout.")},h.remove=function(a,b){var c=a.type.toLowerCase(),d=h.loadout.items[c]=h.loadout.items[c]||[],e=_.findIndex(d,function(b){return b.hash==a.hash&&b.id===a.id});if(e>=0){var f=b.shiftKey?5:1;a.amount-=f,a.amount<=0&&d.splice(e,1)}a.equipped&&d.length>0&&(d[0].equipped=!0)},h.equip=function(a){if(a.equipment){h.loadout.equipped;if("Class"!==a.type||a.equipped)if(a.equipped)a.equipped=!1;else{if(a.tier===c.exotic){var b=_.chain(h.loadout.items).values().flatten().findWhere({sort:a.sort,tier:c.exotic,equipped:!0}).value();_.isUndefined(b)||(b.equipped=!1)}_.chain(h.loadout.items).values().flatten().where({type:a.type,equipped:!0}).each(function(a){a.equipped=!1}),a.equipped=!0}else a.equipped=!0}},f.getSetting("itemSort").then(function(a){h.itemSort=a}),g.$on("dim-settings-updated",function(a,b){_.has(b,"itemSort")&&(h.itemSort=b.itemSort)})}angular.module("dimApp").directive("dimLoadout",a),a.$inject=["dimLoadoutService"],b.$inject=["dimLoadoutService","dimCategory","dimItemTier","toaster","dimPlatformService","dimSettingsService","$scope"]}(),function(){"use strict";function a(){return{controller:b,controllerAs:"vm",bindToController:!0,restrict:"A",scope:{store:"=dimLoadoutPopup"},replace:!0,template:['<div class="loadout-popup-content">','  <div class="loadout-list"><div class="loadout-set">','    <span class="button-create" ng-click="vm.newLoadout($event)">+ Create Loadout</span>','    <span class="button-create-equipped" ng-click="vm.newLoadoutFromEquipped($event)">From Equipped</span>',"  </div></div>",'  <div class="loadout-list">','    <div ng-repeat="loadout in vm.loadouts track by loadout.id" class="loadout-set">','      <span class="button-name" title="{{ loadout.name }}" ng-click="vm.applyLoadout(loadout, $event)">{{ loadout.name }}</span>','      <span class="button-delete" ng-click="vm.deleteLoadout(loadout, $event)"><i class="fa fa-trash-o"></i></span>','      <span class="button-edit" ng-click="vm.editLoadout(loadout, $event)"><i class="fa fa-pencil"></i></span>',"    </div>","  </div>",'  <div class="loadout-list">','    <div class="loadout-set">','      <span class="button-name button-full" ng-click="vm.maxLightLoadout($event)"><i class="fa fa-star"></i> Maximize Light</span>',"    </div>",'    <div class="loadout-set">','      <span class="button-name button-full" ng-click="vm.itemLevelingLoadout($event)"><i class="fa fa-level-up"></i> Item Leveling</span>',"    </div>",'    <div class="loadout-set">','      <span class="button-name button-full" ng-click="vm.gatherEngramsLoadout($event)"><img class="fa" src="/images/engram.svg" height="12" width="12"/> Gather Engrams</span>',"    </div>",'    <div class="loadout-set">','      <span class="button-name button-full" ng-click="vm.startFarmingEngrams($event)"><img class="fa" src="/images/engram.svg" height="12" width="12"/> Engrams to Vault</span>',"    </div>",'    <div class="loadout-set" ng-if="vm.previousLoadout">','      <span class="button-name button-full" ng-click="vm.applyLoadout(vm.previousLoadout, $event)"><i class="fa fa-undo"></i> {{vm.previousLoadout.name}}</span>',"    </div>","  </div>","</div>"].join("")}}function b(a,b,c,d,e,f,g){function h(){c.getLoadouts().then(function(a){k.loadouts=_.sortBy(a,"name")||[],k.loadouts=_.filter(k.loadouts,function(a){return-1===a.classType||a.classType===k.classTypeId})})}function i(a,b){return{classType:-1,name:b,items:_(a).chain().select("equipped").map(function(a){return angular.copy(a)}).groupBy(function(a){return a.type.toLowerCase()}).value()}}function j(a,b,c){var d=_.groupBy(a,"type"),f=function(a){return a.tier===e.exotic},g=_.mapObject(d,function(a,c){return _.max(a,b)}),h=[["Primary","Special","Heavy"],["Helmet","Gauntlets","Chest","Leg"]];_.each(h,function(a){var c=_.pick(g,a),e=_.select(_.values(c),f).length;if(e>1){var h=[];_.each(c,function(a,e){if(f(a)){var g=angular.copy(c),i=!0;_.each(_.omit(c,e),function(a,c){if(f(a)){var e=_.reject(d[c],f);_.isEmpty(e)?i=!1:g[c]=_.max(e,b)}}),i&&h.push(g)}});var i=_.max(h,function(a){return sum(_.values(a),b)});_.assign(g,i)}});var i={};return _.each(g,function(a,b){var c=angular.copy(a);c.equipped=!0,i[b.toLowerCase()]=[c]}),{classType:-1,name:c,items:i}}var k=this;k.previousLoadout=c.previousLoadouts[k.store.id],k.classTypeId={warlock:0,titan:1,hunter:2}[k.store["class"]]||0,a.$on("dim-save-loadout",h),a.$on("dim-delete-loadout",h),h(),k.newLoadout=function(c){b.closeAll(),a.$broadcast("dim-create-new-loadout",{})},k.newLoadoutFromEquipped=function(a){b.closeAll();var c=i(k.store.items,"");c.items=_.pick(c.items,"class","primary","special","heavy","helmet","gauntlets","chest","leg","classitem","artifact","ghost"),c.classType=k.classTypeId,k.editLoadout(c,a)},k.deleteLoadout=function(a,b){confirm("Are you sure you want to delete '"+a.name+"'?")&&c.deleteLoadout(a)},k.editLoadout=function(c,d){b.closeAll(),a.$broadcast("dim-edit-loadout",{loadout:c})},k.applyLoadout=function(a,d){b.closeAll(),g.stop(),a===k.previousLoadout?k.previousLoadout=void 0:k.previousLoadout=i(k.store.items,'Before "'+a.name+'"'),c.previousLoadouts[k.store.id]=k.previousLoadout,c.applyLoadout(k.store,a)},k.itemLevelingLoadout=function(a){var b=_.select(d.getItems(),function(a){return a.canBeEquippedBy(k.store)&&a.talentGrid&&!a.talentGrid.xpComplete}),c=function(a){if(a.equipped)return 1e3;var b=0;return a.locked?(b+=500,b+=10*["Common","Uncommon","Rare","Legendary","Exotic"].indexOf(a.tier)):b+=10*["Common","Uncommon","Exotic","Legendary","Rare"].indexOf(a.tier),b+=10*(a.talentGrid.totalXP/a.talentGrid.totalXPRequired),a.owner==k.store.id?b+=.5:"vault"==a.owner&&(b+=.05),b+=a.primStat?a.primStat.value/1e3:0},e=j(b,c,"Item Leveling");k.applyLoadout(e,a)},k.maxLightLoadout=function(a){var b=["Primary","Special","Heavy","Helmet","Gauntlets","Chest","Leg","ClassItem","Artifact","Ghost"],c=_.select(d.getItems(),function(a){return a.canBeEquippedBy(k.store)&&void 0!==a.primStat&&_.contains(b,a.type)}),e=function(a){var b=a.primStat.value;return a.owner==k.store.id?(b+=.1,a.equipped&&(b+=.1)):"vault"==a.owner&&(b+=.05),b},f=j(c,e,"Maximize Light");k.applyLoadout(f,a)},k.gatherEngramsLoadout=function(a){var b=_.select(d.getItems(),function(a){return a.isEngram()&&"Postmaster"!==a.sort});if(0===b.length)return void f.pop("warning","Gather Engrams","No engrams are available to transfer.");var c=_.mapObject(_.groupBy(b,"type"),function(a,b){return _.first(a,9)}),e={};_.each(c,function(a,b){a&&(e[b.toLowerCase()]=a.map(function(a){return angular.copy(a)}))});var g={classType:-1,name:"Gather Engrams",items:e};k.applyLoadout(g,a)},k.startFarmingEngrams=function(a){b.closeAll(),g.start(k.store)}}angular.module("dimApp").directive("dimLoadoutPopup",a),a.$inject=[],b.$inject=["$rootScope","ngDialog","dimLoadoutService","dimItemService","dimItemTier","toaster","dimEngramFarmingService"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j){var k=this,l=null,m=null,n=null,o=null;g.add({combo:["f"],callback:function(a,c){b.$broadcast("dim-focus-filter-input"),a.preventDefault(),a.stopPropagation()}}),g.add({combo:["esc"],allowIn:["INPUT","SELECT","TEXTAREA"],callback:function(a,c){b.$broadcast("dim-escape-filter-input")}}),g.add({combo:["r"],callback:function(a,b){k.refresh()}}),g.add({combo:["i"],callback:function(a,c){b.$broadcast("dim-toggle-item-details")}}),k.settings={itemDetails:!1,itemStat:!1,itemQuality:!1,condensedItems:!1,characterOrder:"mostRecent"},k.showSetting=function(b){b.stopPropagation(),_.isNull(m)?(a.closeAll(),m=a.open({template:"views/setting.html",className:"app-settings",scope:$("body > div").scope()}),$("body").addClass("app-settings"),m.closePromise.then(function(){m=null,$("body").removeClass("app-settings")})):m.close()},k.showAbout=function(b){b.stopPropagation(),_.isNull(l)?(a.closeAll(),l=a.open({template:"views/about.html",className:"about",scope:$("body > div").scope()}),$("body").addClass("about"),l.closePromise.then(function(){l=null,$("body").removeClass("about")})):l.close()},k.refresh=function(){!function(a){_.isNull(a)||(b.$broadcast("dim-active-platform-updated",{platform:a}),j.updateXur())}(d.getActive())},j.updateXur(),k.showSupport=function(b){b.stopPropagation(),_.isNull(n)?(a.closeAll(),n=a.open({template:"views/support.html",className:"support",scope:$("body > div").scope()}),$("body").addClass("support"),n.closePromise.then(function(){n=null,$("body").removeClass("support")})):n.close()},k.showFilters=function(b){b.stopPropagation(),_.isNull(o)?(a.closeAll(),o=a.open({template:"views/filters.html",className:"filters",scope:$("body > div").scope()}),$("body").addClass("filters"),setTimeout(function(){$("#filter-view span").each(function(){var a=$(this),b=a.text();a.click(function(){addFilter(b)})})},250),o.closePromise.then(function(){o=null,$("body").removeClass("filters")})):o.close()},k.xur=j,k.showXur=function(b){b.stopPropagation(),a.open({template:"views/xur.html",className:"xur"}).closePromise.then(function(){a.closeAll()})};var p=_.throttle(k.refresh,6e4);k.startAutoRefreshTimer=function(){var a=360;b.autoRefreshTimer=f(function(){c.active()||b.isUserInactive()||"visible"!=document.visibilityState||p()},1e3*a)},k.startAutoRefreshTimer(),b.$on("dim-settings-updated",function(a,b){_.has(b,"characterOrder")&&p()}),document.addEventListener("visibilitychange",function(){c.active()||b.isUserInactive()||"visible"!=document.visibilityState||p()},!1)}angular.module("dimApp").controller("dimAppCtrl",a),a.$inject=["ngDialog","$rootScope","loadingTracker","dimPlatformService","dimStoreService","$interval","hotkeys","$timeout","dimStoreService","dimXurService"]}(),function(){"use strict";function a(a,b){var c=b.vm={};c.charColOptions=[{id:3,name:"3"},{id:4,name:"4"},{id:5,name:"5"}],c.vaultColOptions=[{id:4,name:"4"},{id:5,name:"5"},{id:6,name:"6"},{id:7,name:"7"},{id:8,name:"8"},{id:9,name:"9"},{id:10,name:"10"},{id:11,name:"11"},{id:12,name:"12"}],a.getSetting().then(function(a){c.settings=a}),c.save=function(b){a.saveSetting(b,c.settings[b])}}angular.module("dimApp").controller("dimSettingsCtrl",a),a.$inject=["dimSettingsService","$scope"]}(),function(){"use strict";function a(){return{controller:b,controllerAs:"vm",bindToController:!0,scope:{},restrict:"A",template:['<select id="system" ng-if="vm.platforms.length > 1" ng-options="platform.label for platform in vm.platforms" ng-model="vm.active" ng-change="vm.update()"></select>','<i ng-if="vm.active" class="fa fa-user"></i> <span id="user" class="header-right">{{ vm.active.id }}</span>'].join("")}}function b(a,b,c,d,e){function f(){var a=e.get("https://www.bungie.net",{timeout:5e3}).then(function(){return b.getPlatforms()},function(){return b.getPlatforms()});d.addPromise(a)}var g=this;g.active=null,g.platforms=null,g.update=function(){b.setActive(g.active)},f(),a.$on("dim-platforms-updated",function(a,b){g.platforms=b.platforms}),a.$on("dim-active-platform-updated",function(a,b){_.isNull(b.platform)?c.active=g.active=null:c.active=g.active=b.platform})}angular.module("dimApp").directive("dimPlatformChoice",a),a.$inject=[],b.$inject=["$scope","dimPlatformService","dimState","loadingTracker","$http"]}(),function(){"use strict";function a(){return{controller:c,controllerAs:"vm",link:b,bindToController:!0,restrict:"A",template:['<input id="filter-input" placeholder="Search item/perk or is:arc" type="search" name="filter" ng-model="vm.search.query" ng-model-options="{ debounce: 500 }" ng-trim="true" ng-change="vm.filter()">'].join("")}}function b(a,b,c){b.find("input").textcomplete([{words:e,match:/\b((li|le|is:)\w*)$/,search:function(a,b){b($.map(this.words,function(b){return 0===b.indexOf(a)?b:null}))},index:1,replace:function(a){return 0===a.indexOf("is:")?a+" ":a}}],{zIndex:1e3})}function c(a,b,c,e){var f=this,g="#filter-input",h=null;f.search={query:""},a.$on("dim-stores-updated",function(a){h=null,f.filter()}),a.$on("dim-filter-invalidate",function(a){h=null,f.filter()}),a.$on("dim-focus-filter-input",function(a){f.focusFilterInput()}),a.$on("dim-escape-filter-input",function(a){f.blurFilterInputIfEmpty(),f.clearFilter()}),a.$on("dim-clear-filter-input",function(a){f.clearFilter()}),f.blurFilterInputIfEmpty=function(){""===f.search.query&&f.blurFilterInput()},f.focusFilterInput=function(){$(g).focus()},f.blurFilterInput=function(){$(g).blur()},f.clearFilter=function(){f.search.query="",f.filter()},f.filter=function(){function a(a,b){m.push({predicate:a,value:b})}var c,g,h=f.search.query?f.search.query.toLowerCase():"",k=h.split(" "),l="",m=[];_.each(k,function(b){if(b.indexOf("is:")>=0){if(c=b.replace("is:",""),i[c])l=i[c],a(l,c);else for(var e in d)if(d.hasOwnProperty(e)&&~d[e].indexOf(c)){l=e,i[c]=e,a(l,c);break}}else b.indexOf("light:")>=0||b.indexOf("level:")>=0?(c=b.replace("light:","").replace("level:",""),a("light",c)):/^\s*$/.test(b)||a("keyword",b)}),g=function(a){return _.all(m,function(b){return j[b.predicate](b.value,a)})},_.each(b.getStores(),function(a){_.each(a.items,function(a){a.visible=m.length>0?g(a):!0})}),e.getSetting("hideFilteredItems").then(function(a){a&&b.setHeights()})};var i={},j={dmg:function(a,b){return b.dmg===a},type:function(a,b){return b.type.toLowerCase()===a},tier:function(a,b){return b.tier.toLowerCase()===a},incomplete:function(a,b){return b.talentGrid&&!b.complete},complete:function(a,b){return b.complete},upgraded:function(a,b){return b.talentGrid&&b.talentGrid.xpComplete&&!b.complete},xpincomplete:function(a,b){return b.talentGrid&&!b.talentGrid.xpComplete},xpcomplete:function(a,b){return b.talentGrid&&b.talentGrid.xpComplete},ascended:function(a,b){return b.talentGrid&&b.talentGrid.hasAscendNode&&b.talentGrid.ascended},unascended:function(a,b){return b.talentGrid&&b.talentGrid.hasAscendNode&&!b.talentGrid.ascended},reforgeable:function(a,b){return b.talentGrid&&_.any(b.talentGrid.nodes,{name:"Reforge Ready"})},unlocked:function(a,b){return b.lockable&&!b.locked},locked:function(a,b){return b.lockable&&b.locked},dupe:function(a,c){return null===h&&(h=_.chain(b.getStores()).pluck("items").flatten().countBy("hash").value()),h[c.hash]>1},classType:function(a,b){var c;switch(a){case"titan":c=0;break;case"hunter":c=1;break;case"warlock":c=2}return b.classType==c},stattype:function(a,b){return b.stats&&_.any(b.stats,function(b){return b.name.toLowerCase()===a&&b.value>0})},stackable:function(a,b){return b.maxStackSize>1},engram:function(a,b){return b.isEngram()},infusable:function(a,b){return b.talentGrid&&b.talentGrid.infusable},weaponClass:function(a,b){return a.toLowerCase().replace(/\s/g,"")==b.weaponClass},keyword:function(a,b){return b.name.toLowerCase().indexOf(a)>=0||b.talentGrid&&_.any(b.talentGrid.nodes,function(b){return b.name.toLowerCase().indexOf(a)>=0})},light:function(a,b){if(0===a.length||void 0===b.primStat)return!1;var c=["<=",">=","=",">","<"],d="none",e=!1;switch(c.forEach(function(b){return a.substring(0,b.length)===b?(d=b,a=a.substring(b.length),!1):!0},this),d){case"none":e=b.primStat.value==a;break;case"=":e=b.primStat.value==a;break;case"<":e=b.primStat.value<a;break;case"<=":e=b.primStat.value<=a;break;case">":e=b.primStat.value>a;break;case">=":e=b.primStat.value>=a}return e},year:function(a,b){return"year1"===a?1===b.year:"year2"===a?2===b.year:!1}}}angular.module("dimApp").directive("dimSearchFilter",a),a.$inject=[];var d={dmg:["arc","solar","void","kinetic"],type:["primary","special","heavy","helmet","leg","gauntlets","chest","class","classitem","artifact","ghost","horn","consumable","ship","material","vehicle","emblem","bounties","quests","messages","missions","emote"],tier:["common","uncommon","rare","legendary","exotic"],incomplete:["incomplete"],complete:["complete"],xpcomplete:["xpcomplete"],xpincomplete:["xpincomplete","needsxp"],upgraded:["upgraded"],classType:["titan","hunter","warlock"],dupe:["dupe","duplicate"],unascended:["unascended","unassended","unasscended"],ascended:["ascended","assended","asscended"],reforgeable:["reforgeable","reforge","rerollable","reroll"],locked:["locked"],unlocked:["unlocked"],stackable:["stackable"],engram:["engram"],weaponClass:["pulserifle","scoutrifle","handcannon","autorifle","primaryweaponengram","sniperrifle","shotgun","fusionrifle","specialweaponengram","rocketlauncher","machinegun","heavyweaponengram","sidearm","sword"],year:["year1","year2"],infusable:["infusable","infuse"],stattype:["intellect","discipline","strength"]},e=_.flatten(_.values(d)).map(function(a){return"is:"+a});e.push("light:<","light:>","light:<=","light:>=","level:<","level:>","level:<=","level:>="),c.$inject=["$scope","dimStoreService","$interval","dimSettingsService"]}(),function(){function a(a,b){return{restrict:"A",link:function(b,c,d,e){var f=function(a){c[0].contains(a.target)||b.$apply(d.dimClickAnywhereButHere)};a.on("click",f),b.$on("$destroy",function(){a.off("click",f)})}}}angular.module("dimApp").directive("dimClickAnywhereButHere",a),a.$inject=["$document","$parse"]}(),function(){"use strict";function a(a){var b=_.memoize(function(b){return a(function(a,c){$("<img/>").attr("src","http://www.bungie.net"+b).load(function(){$(this).remove(),a("http://www.bungie.net"+b)}).error(function(){$(this).remove(),a(chrome.extension.getURL(b))})})});return{bind:"A",link:function(a,c,d){var e=c[0];a.$watch(d.dimBungieImageFallback,function(a){a&&a.length&&b(a).then(function(a){"IMG"===e.nodeName?e.src=a:e.style.backgroundImage="url("+a+")"})})}}}angular.module("dimApp").directive("dimBungieImageFallback",a),a.$inject=["$q"]}(),function(){"use strict";function a(a){return{controller:b,controllerAs:"vm",bindToController:!0,scope:{},template:['<div ng-repeat="store in vm.stores track by store.id"',"  class=\"storage dim-col-{{(store.id === 'vault') ? vm.vaultCol : vm.charCol}}\"",'  ng-class="{',"    condensed: vm.condensed,","    guardian: !store.isVault,","    vault: store.isVault,","    'hide-filtered': vm.hideFilteredItems,","    'show-elements': vm.showElements",'  }">','  <div dim-store-heading store-data="store"></div>','  <div dim-store-items store-data="store"></div>',"</div>"].join("")}}function b(a,b,c,d,e){var f=this;f.stores=null,f.condensed=!1,f.charCol=3,f.vaultCol=4,a.getSettings().then(function(a){f.hideFilteredItems=a.hideFilteredItems,f.condensed=a.condensed,f.charCol=Math.max(3,Math.min(a.charCol,5)),f.vaultCol=Math.max(4,Math.min(a.vaultCol,12)),f.showElements=a.showElements}),b.$on("dim-settings-updated",function(a,b){_.has(b,"condensed")?f.condensed=b.condensed:_.has(b,"charCol")?f.charCol=b.charCol:_.has(b,"vaultCol")?f.vaultCol=b.vaultCol:_.has(b,"hideFilteredItems")?f.hideFilteredItems=b.hideFilteredItems:_.has(b,"showElements")&&(f.showElements=b.showElements)}),b.$on("dim-stores-updated",function(a,b){f.stores=b.stores}),b.$root.activePlatformUpdated&&(d.addPromise(c.reloadStores()),b.$root.activePlatformUpdated=!1),b.$on("dim-active-platform-updated",function(a,b){d.addPromise(c.reloadStores())})}angular.module("dimApp").directive("dimStores",a),a.$inject=["ngDialog"],b.$inject=["dimSettingsService","$scope","dimStoreService","loadingTracker","$q"]}(),function(){"use strict";function a(a,c){return{controller:b,controllerAs:"vm",bindToController:!0,replace:!0,scope:{store:"=storeData"},template:["<div>",'  <div class="items {{::vm.store.id }}" data-type="item" data-character="{{::vm.store.id }}">','    <div ng-repeat="(key, value) in ::vm.categories track by key" class="section" ng-class="::key.toLowerCase()">','      <div class="title">',"        <span>{{ ::key }}</span>",'        <span class="bucket-count" ng-if="::vm.store.id === \'vault\'">{{ vm.sortSize[key] ? vm.sortSize[key] : 0 }}/{{::vm.store.capacityForItem({sort:key})}}  </span>',"      </div>",'      <div ng-repeat="type in ::value track by type" class="sub-section"',"           ng-class=\"['sort-' + type.replace(' ', '-').toLowerCase(), { empty: !vm.data[type] }]\"",'           ui-on-drop="vm.onDrop($data, $event, false)" ui-on-drag-enter="vm.onDragEnter($event)" ui-on-drag-leave="vm.onDragLeave($event)"',"           drop-channel=\"{{:: type + ',' + vm.store.id + type }}\">",'        <div class="equipped equippable"',"             ng-if=\"::vm.store.id !== 'vault'\"",'             ui-on-drop="vm.onDrop($data, $event, true)" ui-on-drag-enter="vm.onDragEnter($event)" ui-on-drag-leave="vm.onDragLeave($event)"',"              drop-channel=\"{{:: type + ',' + vm.store.id + type }}\">",'          <div ng-repeat="item in vm.data[type] | equipped:true track by item.index" dim-store-item store-data="vm.store" item-data="item"></div>',"        </div>",'        <div class="unequipped equippable" ui-on-drop="vm.onDrop($data, $event, false)" ui-on-drag-enter="vm.onDragEnter($event)" ui-on-drag-leave="vm.onDragLeave($event)" drop-channel="{{ type + \',\' + vm.store.id + type }}">','          <div ng-repeat="item in vm.data[type] | equipped:false | sortItems:vm.itemSort track by item.index" dim-store-item store-data="vm.store" item-data="item"></div>','          <div class="item-target"></div>',"        </div>","      </div>","    </div>","  </div>","</div>"].join("")}}function b(a,b,c,d,e,f,g,h,i,j,k,l){function m(){_.any(n.store.items,{type:"Unknown"})&&(n.categories.Unknown=["Unknown"]),n.store.isVault&&(n.sortSize=_.countBy(n.store.items,"sort")),n.data=_.groupBy(n.store.items,function(a){return a.type})}var n=this,o=null,p=!1,q=document.getElementById("drag-help"),r=0;n.onDragEnter=function(a){j.dragItem&&j.dragItem.owner!==n.store.id&&(r+=1,1===r&&(o=f(function(){j.dragItem&&(p=!0,q.classList.add("drag-dwell-activated"))},1e3)))},n.onDragLeave=function(a){j.dragItem&&j.dragItem.owner!==n.store.id&&(r-=1,0===r&&(p=!1,q.classList.remove("drag-dwell-activated"),f.cancel(o)))},n.onDrop=function(a,b,c){n.moveDroppedItem(angular.element("#"+a).scope().item,c,b,p),p=!1,q.classList.remove("drag-dwell-activated"),f.cancel(o)},n.sortSize=_.countBy(n.store.items,"sort"),n.categories=angular.copy(l),n.moveDroppedItem=k.wrap(function(f,h,j,k){var l=n.store;if(f.notransfer&&f.owner!==l.id)return e.reject(new Error("Cannot move that item off this character."));if(f.owner===n.store.id&&(f.equipped&&h||!f.equipped&&!h))return e.resolve(f);var m=e.when(f.amount);if(f.maxStackSize>1&&f.amount>1&&(j.shiftKey||k)){var o=i.open({template:["<div>","  <h1>",'    <dim-simple-item item-data="vm.item"></dim-simple-item>',"    How much {{vm.item.name}} to move?","  </h1>",'  <div class="ngdialog-inner-content">','    <form ng-submit="vm.finish()">','      <dim-move-amount amount="vm.moveAmount" maximum="vm.maximum"></dim-move-amount>',"    </form>",'    <div class="buttons"><button ng-click="vm.finish()">Move</button></buttons>',"  </div>","</div>"].join(""),scope:a,controllerAs:"vm",controller:["$scope",function(a){var b=this;b.item=a.ngDialogData,b.moveAmount=b.item.amount,b.maximum=c.getStore(b.item.owner).amountOfItem(f),b.finish=function(){a.closeThisDialog(b.moveAmount)}}],plain:!0,data:f,appendTo:"body",overlay:!0,className:"move-amount-popup"});m=o.closePromise.then(function(a){if("string"==typeof a.value)return e.reject(new Error("move-canceled"));var b=a.value;return b})}return m=m.then(function(a){var b=d.moveTo(f,l,h,a),e=f.equipped||h;return e&&(b=b.then(function(){return c.updateCharacters()})),b.then(function(){c.setHeights()})})["catch"](function(a){"move-canceled"!==a.message&&g.pop("error",f.name,a.message)}),b.addPromise(m),m}),h.getSetting("itemSort").then(function(a){n.itemSort=a}),a.$on("dim-settings-updated",function(a,b){_.has(b,"itemSort")&&(n.itemSort=b.itemSort),(_.has(b,"charCol")||_.has(b,"vaultCol"))&&c.setHeights()}),a.$watchCollection("vm.store.items",m)}angular.module("dimApp").directive("dimStoreItems",a).filter("equipped",function(){return function(a,b){return _.select(a||[],function(a){return a.equipped===b})}}).filter("sortItems",function(){return function(a,b){return a=_.sortBy(a||[],"name"),"primaryStat"!==b&&"rarityThenPrimary"!==b&&"quality"!==b||(a=_.sortBy(a,function(a){return a.primStat?-1*a.primStat.value:1e3})),"quality"===b&&(a=_.sortBy(a,function(a){return a.quality?-a.quality:1e3})),"rarity"!==b&&"rarityThenPrimary"!==b||(a=_.sortBy(a,function(a){switch(a.tier){case"Exotic":return 0;case"Legendary":return 1;case"Rare":return 2;case"Uncommon":return 3;case"Common":return 4;default:return 5}})),a}}),a.$inject=["dimStoreService","$window"],b.$inject=["$scope","loadingTracker","dimStoreService","dimItemService","$q","$timeout","toaster","dimSettingsService","ngDialog","$rootScope","dimActionQueue","dimCategory"]}(),function(){"use strict";function a(a,b,g,h){function i(a,f,i){var k=a.vm,l=null,m=document.getElementById("drag-help");k.item.maxStackSize>1&&(f.on("dragstart",function(a){h.dragItem=k.item,k.item.amount>1&&m.classList.remove("drag-help-hidden")}),f.on("dragend",function(){m.classList.add("drag-help-hidden"),delete h.dragItem}),f.on("drag",function(a){a.shiftKey?m.classList.add("drag-shift-activated"):m.classList.remove("drag-shift-activated")})),k.getColor=function(a){var b=0;if(85>=a)b=0;else if(90>=a)b=20;else if(95>=a)b=60;else if(99>=a)b=120;else{if(!(a>=100))return"white";b=190}return"hsl("+b+",85%,60%)"},k.clicked=function(c,d){if(d.stopPropagation(),j&&(b.isOpen(j.id)&&j.close(),j=null),l)b.isOpen(l.id)&&(l.close(),l=null);else if(g.dialogOpen)g.addItemToLoadout(c,d);else{var e=$(f).offset().top<400?" move-popup-bottom":"",h=$("body").width()-$(f).offset().left-320<0?" move-popup-right":"";l=b.open({template:'<div ng-click="$event.stopPropagation();" dim-click-anywhere-but-here="vm.closePopup()" dim-move-popup dim-store="vm.store" dim-item="vm.item"></div>',plain:!0,appendTo:'div[id="'+c.index+'"]',overlay:!1,className:"move-popup"+h+e,showClose:!1,scope:a}),j=l,l.closePromise.then(function(a){l=null})}},k.closePopup=function(){_.isNull(l)||l.close()},!k.item.primStat&&k.item.objectives?a.$watchGroup(["vm.item.percentComplete","vm.itemStat","vm.item.complete"],function(){c(k,k.item)}):k.item.maxStackSize>1?a.$watchGroup(["vm.item.amount"],function(){d(k,k.item)}):a.$watchGroup(["vm.item.primStat.value","vm.itemStat","vm.itemQuality","vm.item.sort"],function(){e(k,k.item)})}return{bindToController:!0,controller:f,controllerAs:"vm",link:i,replace:!0,scope:{store:"=storeData",item:"=itemData"},template:['<div ui-draggable="{{ ::vm.draggable }}" id="{{ ::vm.item.index }}" drag-channel="{{ ::vm.dragChannel }}" ','  title="{{vm.item.primStat.value}} {{::vm.item.name}}" ','  drag="::vm.item.index"','  class="item">','  <div class="item-elem" ng-class="{',"    'search-hidden': !vm.item.visible,","    'complete': vm.item.complete",'  }">','    <div class="img" dim-bungie-image-fallback="::vm.item.icon" ng-click="vm.clicked(vm.item, $event)">','    <div ng-if="vm.itemQuality && vm.quality > 0" class="item-stat item-quality" style="background-color: {{vm.getColor(vm.quality)}};">{{ vm.quality > 0 ? vm.quality + "%" : "" }}</div>','    <img class="element" ng-if=":: vm.item.dmg && vm.item.dmg !== \'kinetic\'" ng-src="/images/{{::vm.item.dmg}}.png"/>','    <div ng-class="vm.badgeClassNames" ng-if="vm.showBadge">{{ vm.badgeCount }}</div>',"  </div>","</div>"].join("")
};var j}function b(a,b){_.has(b,"itemStat")&&(a.itemStat=b.itemStat),_.has(b,"itemQuality")&&(a.itemQuality=b.itemQuality)}function c(a,b){var c=!b.complete&&a.itemStat;a.showBadge=c,c&&(a.badgeClassNames={"item-stat":!0},a.badgeCount=b.percentComplete+"%")}function d(a,b){a.showBadge=!0,a.badgeClassNames={"item-stat":!0},a.badgeCount=b.amount}function e(a,b){a.badgeClassNames={"damage-type":!1,"damage-solar":!1,"damage-arc":!1,"damage-void":!1,"damage-kinetic":!1,"item-stat":!1,"stat-damage-solar":!1,"stat-damage-arc":!1,"stat-damage-void":!1,"stat-damage-kinetic":!1};var c=a.itemStat&&b.primStat&&b.primStat.value,d=!a.itemStat&&"Weapons"===a.item.sort;a.showBadge=c||d,a.quality=b.quality,c?(a.badgeClassNames["item-stat"]=!0,a.badgeClassNames["stat-damage-"+b.dmg]=!0,a.badgeCount=b.primStat.value):d&&(a.badgeClassNames["damage-"+b.dmg]=!0,a.badgeClassNames["damage-type"]=!0,a.badgeCount=""),a.itemQuality&&a.quality>0&&(a.badgeClassNames["item-stat-no-bg"]=!0)}function f(a,c,d){var e=this;switch(e.itemStat=!1,e.itemQuality=!1,e.dragChannel=e.item.notransfer?e.item.owner+e.item.type:e.item.type,e.item.type){case"Lost Items":case"Missions":case"Bounties":case"Quests":case"Special Orders":case"Messages":e.draggable=!1;break;default:e.draggable=!0}c.getSettings().then(function(a){b(e,a)}),a.$on("dim-settings-updated",function(a,c){b(e,c)})}angular.module("dimApp").directive("dimStoreItem",a),a.$inject=["dimStoreService","ngDialog","dimLoadoutService","$rootScope"],f.$inject=["$rootScope","dimSettingsService","$scope"]}(),function(){"use strict";function a(a){function c(b,c){var d=b.vm,e=null;$(document).ready(function(){c.scrollToFixed({marginTop:61,fixed:function(){$(document.body).addClass("something-is-sticky"),$(this).addClass("fixed-header")},unfixed:function(){$(document.body).removeClass("something-is-sticky"),$(this).removeClass("fixed-header")}})}),d.openLoadoutPopup=function(c){c.stopPropagation(),_.isNull(e)?(a.closeAll(),e=a.open({template:'<div ng-click="$event.stopPropagation();" dim-click-anywhere-but-here="closeThisDialog()" dim-loadout-popup="vm.store"></div>',plain:!0,appendTo:'div[loadout-id="'+d.store.id+'"]',overlay:!1,className:"loadout-popup",showClose:!1,scope:b}),e.closePromise.then(function(a){e=null})):e.close()},c.addClass("character")}return{controller:b,controllerAs:"vm",bindToController:!0,scope:{store:"=storeData"},link:c,template:["<div class=\"character-box\" ng-class=\"::{ 'vault-box': !vm.isGuardian }\" ng-style=\"{ 'background-image': 'url(http://bungie.net' + vm.store.background + ')' }\">","  <div class=\"emblem\" ng-if=\"::vm.isGuardian\" ng-style=\"{ 'background-image': 'url(http://bungie.net' + vm.store.icon + ')' }\"></div>",'  <div class="class">{{:: vm.store.class || "Vault" }}</div>','  <div class="race-gender" ng-if="::vm.isGuardian">{{:: vm.store.race }} {{:: vm.store.gender }}</div>','  <div class="level" ng-if="::vm.isGuardian">Level {{ vm.store.level }}</div>','  <div class="level powerLevel" ng-if="vm.isGuardian">{{ vm.store.powerLevel }}</div>','  <div class="currency" ng-if="::!vm.isGuardian"> {{ vm.store.glimmer }} <img src="/images/glimmer.png"></div>','  <div class="currency legendaryMarks" ng-if="::!vm.isGuardian"> {{ vm.store.legendaryMarks }} <img src="/images/legendaryMarks.png"></div>','  <div class="levelBar" ng-if="::vm.isGuardian">','    <div class="barFill" ng-style="{width: vm.store.percentToNextLevel + \'%\'}"></div>',"  </div>",'  <div class="loadout-button" ng-if="::vm.isGuardian" ng-click="vm.openLoadoutPopup($event)"><i class="fa fa-chevron-down"></i></div>',"</div>",'<div class="loadout-menu" loadout-id="{{:: vm.store.id }}"></div>','<div dim-stats stats="vm.store.stats" ng-if="vm.isGuardian"></div>',"</div>"].join("")}}function b(a){var b=this;b.isGuardian=!b.store.isVault}angular.module("dimApp").directive("dimStoreHeading",a),a.$inject=["ngDialog"],b.$inject=["$scope"]}(),function(){"use strict";function a(a,c){return{replace:!0,scope:{item:"=itemData"},template:['<div title="{{ vm.item.primStat.value }} {{ vm.item.name }}" alt="{{ vm.item.primStat.value }} {{ vm.item.name }}" class="item">','  <div class="item-elem" ng-class="{ complete: vm.item.complete }">','    <div class="img" dim-bungie-image-fallback="vm.item.icon">','      <div class="damage-type" ng-if="!vm.item.itemStat && vm.item.sort === \'Weapons\'" ng-class="\'damage-\' + vm.item.dmg"></div>','      <div class="item-stat" ng-if="vm.item.primStat.value || vm.item.maxStackSize > 1" ng-class="\'stat-damage-\' + vm.item.dmg">{{ vm.item.primStat.value || vm.item.amount }}</div>',"    </div>","  </div>","</div>"].join(""),bindToController:!0,controllerAs:"vm",controller:b}}function b(){}angular.module("dimApp").directive("dimSimpleItem",a),a.$inject=["dimStoreService","dimItemService"],b.$inject=[]}(),function(){"use strict";function a(){return{controller:b,controllerAs:"vm",bindToController:!0,scope:{stats:"="},template:['<div class="stats">','  <div class="stat" title="{{vm.formatTooltip(\'STAT_INTELLECT\')}}">','    <img src="images/intellect.png" /><div class="bar" ng-repeat="n in vm.stats.STAT_INTELLECT.tiers track by $index">','      <div class="progress" ng-class="{complete: (n / 60) === 1 }" style="width:{{n/60*100}}%"></div></div></div>','  <div class="stat" title="{{vm.formatTooltip(\'STAT_DISCIPLINE\')}}">','    <img src="images/discipline.png" /><div class="bar" ng-repeat="n in vm.stats.STAT_DISCIPLINE.tiers track by $index">','      <div class="progress" ng-class="{complete: (n / 60) === 1 }" style="width:{{n/60*100}}%"></div></div></div>','  <div class="stat" title="{{vm.formatTooltip(\'STAT_STRENGTH\')}}">','    <img src="images/strength.png" /><div class="bar" ng-repeat="n in vm.stats.STAT_STRENGTH.tiers track by $index">','      <div class="progress" ng-class="{complete: (n / 60) === 1 }" style="width:{{n/60*100}}%"></div></div></div>',"</div>"].join("")}}function b(a){var b=this;b.formatTooltip=function(a){var c=" ("+b.stats[a].value+"/300)",d=b.stats[a].tier,e=b.stats[a].cooldown||"";return 5!==d&&(c=" ("+b.stats[a].value%60+"/60 for T"+(d+1)+")"),e&&(e="\n"+b.stats[a].effect+" cooldown: "+e),"T"+d+" "+b.stats[a].name+c+e}}angular.module("dimApp").directive("dimStats",a),a.$inject=[],b.$inject=["$scope"]}(),function(){"use strict";function a(a){return{controller:b,controllerAs:"vm",bindToController:!0,scope:{},template:['<div id="engram-farming" ng-if="vm.service.active">','  <div class="engram-icon">','    <div class="engram-count">{{vm.service.engramsMoved}}</div>','    <img class="engram" ng-class="{ active: (vm.service.movingEngrams || vm.service.makingRoom) }" src="/images/engram.svg" height="60" width="60"/>',"  </div>",'  <div class="engram-details">',"    <h1>Sending {{vm.service.store.race}} {{vm.service.store.name}}'s engrams to the vault</h1>","    <p>DIM will watch for engrams and move them to the vault. It'll also keep one space open per type to keep engrams from going to the Postmaster.</p>","  </div>",'  <button ng-click="vm.stop($event)">Stop</button>',"</div>"].join("")}}function b(a){var b=this;angular.extend(b,{service:a,stop:function(b){b.preventDefault(),a.stop()}})}angular.module("dimApp").directive("dimEngramFarming",a),a.$inject=["dimEngramFarmingService"],b.$inject=["dimEngramFarmingService"]}(),function(){"use strict";function a(a){return{controller:b,controllerAs:"vm",bindToController:!0,restrict:"E",scope:{amount:"=amount",maximum:"=maximum"},replace:!0,template:['<div class="move-amount">','  <span class="move-amount-arrow" tabindex="-1" ng-click="vm.decrement()">&#9664;</span>','  <input ng-model="vm.amount" type="text" ng-blur="vm.constrain()"/>','  <div class="move-amount-slider">','    <rzslider rz-slider-model="vm.amount" rz-slider-options="{ floor: 1, ceil: vm.maximum, showSelectionBar: true, hideLimitLabels: true }"></rzslider>',"  </div>",'  <span class="move-amount-arrow" tabindex="-1" ng-click="vm.increment()">&#9654;</span>',"</div>"].join(""),link:function(b,c,d){a(function(){b.$broadcast("rzSliderForceRender");var a=c.find("input");a.focus(),a.get(0).setSelectionRange(0,a.get(0).value.length)})}}}function b(){var a=this;a.increment=function(){a.amount=Math.min(a.amount+1,a.maximum)},a.decrement=function(){a.amount=Math.max(a.amount-1,1)},a.constrain=function(){var b=parseInt(a.amount,10);isNaN(b)&&(b=a.maximum),a.amount=Math.max(1,Math.min(b,a.maximum))}}angular.module("dimApp").directive("dimMoveAmount",a),a.$inject=["$timeout"],b.$inject=[]}(),function(){"use strict";function a(a){return{controller:b,controllerAs:"vm",bindToController:!0,restrict:"A",scope:{store:"=dimStore",item:"=dimItem"},replace:!0,template:['<div class="move-popup" alt="" title="">','  <div dim-move-item-properties="vm.item" dim-infuse="vm.infuse"></div>','  <dim-move-amount ng-if="vm.item.amount > 1 && !vm.item.notransfer" amount="vm.moveAmount" maximum="vm.maximum"></dim-move-amount>','  <div class="interaction">','    <div class="locations" ng-repeat="store in vm.stores track by store.id">','      <div class="move-button move-vault" alt="{{::vm.characterInfo(store) }}" title="{{::vm.characterInfo(store) }}" ','        ng-if="vm.canShowVault(vm.item, vm.store, store)" ng-click="vm.moveItemTo(store)" ','        data-type="item" data-character="{{::store.id}}">',"        <span>Vault</span>","      </div>",'      <div class="move-button move-store" alt="{{::vm.characterInfo(store) }}" title="{{::vm.characterInfo(store) }}" ','        ng-if="vm.canShowStore(vm.item, vm.store, store)" ng-click="vm.moveItemTo(store)" ','        data-type="item" data-character="{{::store.id}}" style="background-image: url(http://bungie.net{{::store.icon}})"> ',"        <span>Store</span>","      </div>",'      <div class="move-button move-equip" alt="{{::vm.characterInfo(store) }}" title="{{::vm.characterInfo(store) }}" ','        ng-if="vm.canShowEquip(vm.item, vm.store, store)" ng-click="vm.moveItemTo(store, true)" ','        data-type="equip" data-character="{{::store.id}}" style="background-image: url(http://bungie.net{{::store.icon}})">',"        <span>Equip</span>","      </div>","    </div>",'    <div class="move-button move-consolidate" alt="Consolidate" title="Consolidate" ','      ng-if="!vm.item.notransfer && vm.item.maxStackSize > 1" ng-click="vm.consolidate()">',"      <span>Take</span>","    </div>",'    <div class="move-button move-distribute" alt="Distribute Evenly" title="Distribute Evenly" ','      ng-if="!vm.item.notransfer && vm.item.maxStackSize > 1" ng-click="vm.distribute()">',"      <span>Split</span>","    </div>",'  <div class="infuse-perk" ng-if="vm.item.talentGrid.infusable && vm.item.sort !== \'Postmaster\'" ng-click="vm.infuse(vm.item, $event)" title="Infusion fuel finder" alt="Infusion calculator" style="background-image: url(\'/images/{{vm.item.sort}}.png\');"></div>',"  </div>","</div>"].join("")}}function b(a,b,c,d,e,f,g,h,i){function j(a){return a.charAt(0).toUpperCase()+a.slice(1)}var k=this;a.$watch("vm.item",function(){if(k.item.amount>1){var a=c.getStore(k.item.owner);k.maximum=a.amountOfItem(k.item),k.moveAmount=k.maximum}}),k.infuse=function(b,c){"Postmaster"!==b.sort&&(c.stopPropagation(),a.$parent.closeThisDialog(),e.open({template:"views/infuse.html",className:"app-settings",data:b,scope:$("#infuseDialog").scope()}))},k.characterInfo=function(a){return a.isVault?"Vault":a.level+" "+j(a.race)+" "+j(a.gender)+" "+j(a["class"])},k.moveItemTo=h.wrap(function(e,f){i.show("movebox",{title:"Did you know?",body:["<p>Items can be dragged and dropped between different characters/vault columns.</p>","<p>Try it out next time!<p>"].join(""),hide:"Don't show this tip again"});var h=k.item.equipped||f,j=d.moveTo(k.item,e,f,k.moveAmount);return h&&(j=j.then(function(){return c.updateCharacters()})),j=j.then(function(){c.setHeights()})["catch"](function(a){g.pop("error",k.item.name,a.message)}),b.addPromise(j),a.$parent.closeThisDialog(),j}),k.consolidate=h.wrap(function(){var e=_.filter(c.getStores(),function(a){return a.id!==k.item.owner&&!a.isVault}),h=c.getVault(),i=f.all(e.map(function(a){var b=_.find(a.items,function(a){return a.hash===k.item.hash&&"Postmaster"!==a.sort});if(b){var c=a.amountOfItem(k.item);return d.moveTo(b,h,!1,c)}}));return k.store.isVault||(i=i.then(function(){var a=_.find(h.items,function(a){return a.hash===k.item.hash&&"Postmaster"!==a.sort});if(a){var b=h.amountOfItem(k.item);return d.moveTo(a,k.store,!1,b)}})),i=i.then(function(){c.setHeights();var a;a=k.store.isVault?"All "+k.item.name+" is now in your vault.":"All "+k.item.name+" is now on your "+k.store.race+" "+k.store["class"]+".",g.pop("success","Consolidated "+k.item.name,a)})["catch"](function(a){g.pop("error",k.item.name,a.message)}),b.addPromise(i),a.$parent.closeThisDialog(),i}),k.distribute=h.wrap(function(){function e(a){return f.all(a.map(function(a){var b=_.find(a.source.items,function(a){return a.hash===k.item.hash});return d.moveTo(b,a.target,!1,a.amount)}))}var h=_.sortBy(c.getStores(),function(a){return"vault"==a.id?2:1}),i=0,j=h.map(function(a){var b=a.amountOfItem(k.item);return i+=b,b}),l=h.length-1,m=i%l,n=h.map(function(a,b){if(b>=l)return 0;var c;return c=m>0?Math.ceil(i/l):Math.floor(i/l),m--,c}),o=_.zip(j,n).map(function(a){return a[1]-a[0]}),p=[],q=[],r=h.length-1,s=h[r];o.forEach(function(a,b){0>a&&b!==r?p.push({source:h[b],target:s,amount:-a}):a>0&&q.push({source:s,target:h[b],amount:a})});var t=e(p).then(function(){return e(q)});return t=t.then(function(){c.setHeights(),g.pop("success","Distributed "+k.item.name,k.item.name+" is now equally divided between characters.")})["catch"](function(a){g.pop("error",k.item.name,a.message)}),b.addPromise(t),a.$parent.closeThisDialog(),t}),k.stores=c.getStores(),k.canShowVault=function(a,b,c){return b.isVault?!1:c.isVault?!a.notransfer:!1},k.canShowStore=function(a,b,c){if(c.isVault)return!1;if(a.notransfer){if(a.equipped&&b.id===c.id)return!0}else{if(b.id!==c.id)return!0;if(a.equipped)return!0}return!1},k.canShowEquip=function(a,b,c){if(c.isVault||!a.equipment)return!1;if(a.notransfer){if(!a.equipped&&b.id===c.id&&"Postmaster"!==a.sort)return!0}else{if(b.id!==c.id&&"Postmaster"!==a.sort)return!0;if(!a.equipped&&"Postmaster"!==a.sort)return!0}return!1}}angular.module("dimApp").directive("dimMovePopup",a),a.$inject=["ngDialog"],b.$inject=["$scope","loadingTracker","dimStoreService","dimItemService","ngDialog","$q","toaster","dimActionQueue","dimInfoService"]}(),function(){"use strict";function a(){return{bindToController:!0,controller:b,controllerAs:"vm",scope:{talentGrid:"=dimTalentGrid",infuse:"&dimInfuse"},restrict:"E",replace:!0,template:['<svg preserveAspectRatio="xMaxYMin meet" svg-bind-viewbox="0 0 {{(vm.numColumns * vm.totalNodeSize - vm.nodePadding) * vm.scaleFactor}} {{(vm.numRows * vm.totalNodeSize - vm.nodePadding) * vm.scaleFactor + 1}}" class="talent-grid" ng-attr-height="{{(vm.numRows * vm.totalNodeSize - vm.nodePadding) * vm.scaleFactor}}" ng-attr-width="{{(vm.numColumns * vm.totalNodeSize - vm.nodePadding) * vm.scaleFactor}}">',' <g ng-attr-transform="scale({{vm.scaleFactor}})">',"  <g class=\"talent-node\" ng-attr-transform=\"translate({{node.column * (vm.totalNodeSize)}},{{node.row * (vm.totalNodeSize)}})\" ng-repeat=\"node in vm.talentGrid.nodes | talentGridNodes track by $index\" ng-class=\"{ 'talent-node-activated': node.activated, 'talent-node-showxp': (!node.activated && node.xpRequired), 'talent-node-default': (node.activated && !node.xpRequired && !node.exclusiveInColumn) }\" ng-click=\"node.name == 'Infuse' ? vm.infuse({'$event': $event}) : true\">",'    <circle r="16" cx="-17" cy="17" transform="rotate(-90)" class="talent-node-xp" stroke-width="2" ng-attr-stroke-dasharray="{{100.0 * node.xp / node.xpRequired}} 100" />','    <image class="talent-node-img" xlink:href="" ng-attr-xlink:href="{{ node.icon | bungieIcon }}" x="20" y="20" height="96" width="96" transform="scale(0.25)"/>',"    <title>{{node.name}}\n{{node.description}}</title>","  </g>","</g>","</svg>"].join("")}}function b(a){var b=this;b.nodeSize=34,b.nodePadding=4,b.scaleFactor=1.1,b.totalNodeSize=b.nodeSize+b.nodePadding,b.talentGrid&&(b.numColumns=_.max(b.talentGrid.nodes,"column").column+1,b.numRows=_.max(b.talentGrid.nodes,"row").row+1)}angular.module("dimApp").directive("dimTalentGrid",a).filter("talentGridNodes",function(){return function(a){return _.filter(a||[],{hidden:!1})}}).filter("bungieIcon",function(a){return function(b){return a.trustAsResourceUrl(chrome.extension.getURL(b))}}).directive("svgBindViewbox",function(){return{link:function(a,b,c){c.$observe("svgBindViewbox",function(a){b.get(0).setAttribute("viewBox",a)})}}}),b.$inject=["$scope"]}(),function(){"use strict";function a(a){return{bindToController:!0,controller:b,controllerAs:"vm",scope:{item:"=dimMoveItemProperties",compareItem:"=dimCompareItem",infuse:"=dimInfuse"},restrict:"A",replace:!0,template:["<div>",'<div ng-class="vm.classes">','  <span ng-if="vm.item.lockable" class="fa-stack lock-icon" ng-class="{ locking: vm.locking }" ng-click="vm.setLockState(vm.item);">','    <i class="fa fa-circle fa-stack-2x"></i>',"    <i class=\"fa fa-stack-1x fa-inverse\" ng-class=\"{ 'fa-lock': vm.item.locked, 'fa-unlock': !vm.item.locked, locking: vm.locking }\"></i>","  </span>",'  <span><img class="title-element" ng-if=":: vm.item.dmg && vm.item.dmg !== \'kinetic\'" ng-src="/images/{{::vm.item.dmg}}.png"/>','    <a target="_new" href="http://db.destinytracker.com/inventory/item/{{vm.item.hash}}">{{vm.title}}</a></span>','  <span ng-if="vm.light" ng-bind="vm.light"></span>',"  <span ng-if=\"::vm.item.sort == 'Weapons' || vm.item.sort =='Postmaster'\" ng-bind=\"::vm.item.typeName\"></span>",'  <span ng-if="vm.item.type === \'Bounties\' && !vm.item.complete" class="bounty-progress"> | {{vm.item.percentComplete}}%</span>','  <span class="pull-right move-popup-info-detail" ng-click="vm.itemDetails = !vm.itemDetails;" ng-if="!vm.showDetailsByDefault && (vm.showDescription || vm.hasDetails) && !vm.item.classified"><span class="fa fa-info-circle"></span></span>',"</div>",'<div class="item-xp-bar" ng-if="vm.item.percentComplete != null && !vm.item.complete">',"  <div ng-style=\"{ width: vm.item.percentComplete + '%' }\"></div>","</div>",'<div class="item-description" ng-if="vm.itemDetails && vm.showDescription" ng-bind="::vm.item.description"></div>','<div class="item-details" ng-if="vm.item.classified">Classified item. Bungie does not yet provide information about this item. Item is not yet transferable.</div>','<div class="item-details" ng-if="vm.itemDetails && vm.hasDetails">','  <div ng-if="vm.classType && vm.classType !==\'Unknown\'" class="stat-box-row">','    <span class="stat-box-text" ng-bind="vm.classType"></span>',"  </div>",'  <div class="item-stats" ng-repeat="stat in vm.item.stats track by $index">','    <div class="stat-box-row">','       <span class="stat-box-text"> {{ stat.name }} </span>','       <span class="stat-box-outer" ng-class="{ \'show-quality\': vm.itemQuality }">','         <span ng-if="stat.bar && stat.value && (stat.value === stat.equippedStatsValue || !stat.comparable)" class="stat-box-inner" style="width: {{ 100 * stat.value / stat.maximumValue }}%"></span>','         <span ng-if="stat.bar && stat.value && stat.value < stat.equippedStatsValue && stat.comparable" class="stat-box-inner" style="width: {{ 100 * stat.value / stat.maximumValue }}%"></span>','         <span ng-if="stat.bar && stat.value < stat.equippedStatsValue && stat.comparable" class="stat-box-inner lower-stats" style="width: {{ 100 * (stat.equippedStatsValue - stat.value) / stat.maximumValue }}%"></span>','         <span ng-if="stat.bar && stat.value > stat.equippedStatsValue && stat.comparable" class="stat-box-inner" style="width: {{ 100 * stat.equippedStatsValue / stat.maximumValue }}%"></span>','         <span ng-if="stat.bar && stat.value > stat.equippedStatsValue && stat.comparable" class="stat-box-inner higher-stats" style="width: {{ 100 * (stat.value - stat.equippedStatsValue) / stat.maximumValue }}%"></span>',"         <span ng-if=\"!stat.bar && (!stat.equippedStatsName || stat.comparable)\" ng-class=\"{ 'higher-stats': (stat.value > stat.equippedStatsValue), 'lower-stats': (stat.value < stat.equippedStatsValue)}\">{{ stat.value }}</span>","       </span>",'       <span class="stat-box-val" ng-class="{ \'higher-stats\': (stat.value > stat.equippedStatsValue && stat.comparable), \'lower-stats\': (stat.value < stat.equippedStatsValue && stat.comparable)}" ng-show="{{ stat.bar }}" class="lower-stats stat-box-val">{{ stat.value }}</span>','       <span ng-show="vm.itemQuality && stat.scaled > 0" class="stat-box-val" ng-class="{ \'show-quality\': vm.itemQuality && stat.scaled > 0  }" ng-show="{{ stat.bar }}" style="color: {{ vm.getColor(vm.getPercent(stat.scaled,stat.split)) }}">({{ vm.getPercent(stat.scaled,stat.split) }}%)</span>',"    </div>","  </div>",'  <div ng-if="vm.item.quality !== null && vm.item.quality >= 0" class="stat-box-row">','    <span class="stat-box-text">Stats quality</span>','    <span class="stat-box-val" style="width:50%;color:{{ vm.getColor(vm.item.quality) }}">{{ vm.item.quality }}% of max possible roll</span>',"  </div>","</div>",'<div class="item-details item-perks" ng-if="vm.item.talentGrid && vm.itemDetails">','  <dim-talent-grid dim-talent-grid="vm.item.talentGrid" dim-infuse="vm.infuse(vm.item, $event)"/>',"</div>",'<div class="item-details item-objectives" ng-if="vm.item.objectives.length && vm.itemDetails">','  <div class="objective-row" ng-repeat="objective in vm.item.objectives track by $index" ng-class="{\'objective-complete\': objective.complete, \'objective-boolean\': objective.boolean }">','     <div class="objective-checkbox"><div></div></div>','     <div class="objective-progress">','       <div class="objective-progress-bar" style="width: {{ 100 * objective.progress / objective.completionValue }}%"></div>',"       <div class=\"objective-description\">{{ objective.description || (objective.complete ? 'Complete' : 'Incomplete') }}</div>",'       <div class="objective-text">{{ objective.progress }} / {{ objective.completionValue }}</div>',"     </div>","  </div>","</div>"].join("")}}function b(a,b,c,d,e,f,g,h){function i(a){if(a&&j.item.stats)for(var b in Object.getOwnPropertyNames(j.item.stats)){var c=a.stats&&a.stats[b];if(c){var d=j.item.stats[b];d&&(d.equippedStatsValue=c.value,d.equippedStatsName=c.name,d.comparable=d.equippedStatsName===d.name||"Magazine"===d.name&&"Energy"===d.equippedStatsName||"Energy"===d.name&&"Magazine"===d.equippedStatsName)}}}var j=this;j.hasDetails=j.item.stats&&j.item.stats.length||j.item.talentGrid||j.item.objectives,j.showDescription=!0,j.locking=!1,g.$on("dim-toggle-item-details",function(){j.itemDetails=!j.itemDetails}),j.getPercent=function(a,b){return Math.round(a/b*100)},j.getColor=function(a){var b=0;if(85>=a)b=0;else if(90>=a)b=20;else if(95>=a)b=60;else if(99>=a)b=120;else{if(!(a>=100))return"white";b=190}return"hsl("+b+",85%,60%)"},j.setLockState=function(a){if(!j.locking){var b;b="vault"===a.owner?c.getStores()[0]:c.getStore(a.owner),j.locking=!0,d.setLockState(a,b,!a.locked).then(function(b){a.locked=b,h.$broadcast("dim-filter-invalidate")})["finally"](function(){j.locking=!1})}},j.classes={"item-name":!0,"is-arc":!1,"is-solar":!1,"is-void":!1},j.title=a.trustAsHtml(j.item.name),j.light="",j.classType="",j.showDetailsByDefault=!j.item.equipment&&j.item.notransfer,j.itemDetails=j.showDetailsByDefault,e.getSetting("itemDetails").then(function(a){j.itemDetails=j.itemDetails||a}),j.itemQuality=!1,e.getSetting("itemQuality").then(function(a){j.itemQuality=j.itemQuality||a}),j.item.primStat&&(j.light=j.item.primStat.value.toString(),3897883278===j.item.primStat.statHash?(j.light+=" Defense",j.classType=j.item.classTypeName[0].toUpperCase()+j.item.classTypeName.slice(1)):368428387===j.item.primStat.statHash&&(j.light+=" Attack",j.classes["is-"+j.item.dmg]=!0)),j.item.equipment&&(j.compareItem?g.$watch("vm.compareItem",i):g.$watch("$parent.$parent.vm.store.items",function(a){var b=_.find(a,function(a){return a.equipped&&a.type===j.item.type});i(b)}))}angular.module("dimApp").directive("dimMoveItemProperties",a),a.$inject=["$sce"],b.$inject=["$sce","$q","dimStoreService","dimItemService","dimSettingsService","ngDialog","$scope","$rootScope"]}(),function(){"use strict";function a(a,b,c,d,e){var f=this;angular.extend(f,{getAllItems:!0,showLockedItems:!1,target:null,infused:0,exotic:!1,infusable:[],transferInProgress:!1,setSourceItem:function(a){f.source=a,f.infused=0,f.target=null,f.statType=3897883278===f.source.primStat.statHash?"Defense":368428387===f.source.primStat.statHash?"Attack":"Unknown",f.wildcardMaterialIcon="General"===a.sort?"2e026fc67d445e5b2630277aa794b4b1":"Attack"===f.statType?"f2572a4949fb16df87ba9760f713dac3":"972ae2c6ccbf59cde293a2ed50a57a93",f.wildcardMaterialIcon="/common/destiny_content/icons/"+f.wildcardMaterialIcon+".jpg",f.wildcardMaterialCost="General"===a.sort?2:10},selectItem:function(a,b){b&&b.stopPropagation(),f.target=a,f.infused=f.target.primStat.value},getItems:function(){var a=b.getStores(),c=[];f.getAllItems||(a=_.filter(a,function(a){return a.id===f.source.owner})),_.each(a,function(a,b,d){var e=_.filter(a.items,function(a){return a.primStat&&(!a.locked||f.showLockedItems)&&a.type==f.source.type&&a.primStat.value>f.source.primStat.value});c=c.concat(e)}),c=_.sortBy(c,function(a){return a.primStat.value+a.talentGrid.totalXP/a.talentGrid.totalXPRequired*.5}),f.infusable=c,c.length?f.selectItem(c[c.length-1]):(f.target=null,f.infused=0)},closeDialog:function(){a.$parent.closeThisDialog()},transferItems:function(){var a=b.getStore(f.source.owner),c={},d=f.target.type.toLowerCase();c[d]=c[d]||[];var g=angular.copy(f.target);g.equipped=!1,c[d].push(g),c[f.source.type.toLowerCase()].push(f.source),c.material=[],"General"===f.sort?c.material.push({id:"0",hash:937555249,amount:2,equipped:!1}):"Attack"===f.statType?c.material.push({id:"0",hash:1898539128,amount:10,equipped:!1}):c.material.push({id:"0",hash:1542293174,amount:10,equipped:!1}),f.exotic&&c.material.push({id:"0",hash:452597397,amount:1,equipped:!1});var h={classType:-1,name:"Infusion Materials",items:c};return f.transferInProgress=!0,e.applyLoadout(a,h).then(function(){f.transferInProgress=!1})}}),f.setSourceItem(a.$parent.ngDialogData),f.getItems()}angular.module("dimApp").controller("dimInfuseCtrl",a),a.$inject=["$scope","dimStoreService","dimItemService","ngDialog","dimLoadoutService"]}(),function(){"use strict";function a(a,b,c,d,e){function f(){var a=_.chain(b.itemCategories).values().flatten().pluck("currency").pluck("itemHash").unique().value();g.totalCoins={},a.forEach(function(a){g.totalCoins[a]=sum(d.getStores(),function(b){return b.amountOfItem({hash:a})})})}var g=this,h=null,i=null,j=null;f(),a.$on("dim-stores-updated",function(a,b){f()}),a.$on("ngDialog.opened",function(a,b){h&&b.position({my:"left top",at:"left bottom+4",of:j,collision:"flip"})}),angular.extend(g,{itemCategories:b.itemCategories,categoryOrder:["Exotic Gear","Curios","Material Exchange"],itemClicked:function(b,e){if(e.stopPropagation(),h&&h.close(),i!==b){i=b,j=angular.element(e.currentTarget);var f=_.flatten(d.getStores().map(function(a){return _.filter(a.items,{hash:b.hash})})),g=sum(f,"amount");h=c.open({template:['<div class="move-popup" dim-click-anywhere-but-here="closeThisDialog()">','  <div dim-move-item-properties="vm.item" dim-compare-item="vm.compareItem"></div>','  <div class="item-details more-item-details" ng-if="vm.item.equipment && vm.compareItems.length">',"    <div>Compare with what you already have:</div>",'    <div class="compare-items">','      <dim-simple-item ng-repeat="ownedItem in vm.compareItems track by ownedItem.index" item-data="ownedItem" ng-click="vm.setCompareItem(ownedItem)" ng-class="{ selected: (ownedItem.index === vm.compareItem.index) }"></dim-simple-item>',"    </div>","  </div>",'  <div class="item-description" ng-if="!vm.item.equipment">You have {{vm.compareItemCount}} of these.</div>',"</div>"].join(""),plain:!0,overlay:!1,className:"move-popup xur-move-popup",showClose:!1,scope:angular.extend(a.$new(!0),{}),controllerAs:"vm",controller:["$scope",function(a){var c=this;angular.extend(c,{item:b,compareItems:f,compareItem:_.first(f),compareItemCount:g,setCompareItem:function(a){this.compareItem=a}})}]})}else i=null,h=null,j=null},close:function(){h&&h.close(),a.closeThisDialog()}})}angular.module("dimApp").controller("dimXurCtrl",a),a.$inject=["$scope","dimXurService","ngDialog","dimStoreService","$timeout"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(a){return{helmet:a.filter(function(a){return"Helmet"===a.type}),gauntlets:a.filter(function(a){return"Gauntlets"===a.type}),chest:a.filter(function(a){return"Chest"===a.type}),leg:a.filter(function(a){return"Leg"===a.type}),classItem:a.filter(function(a){return"ClassItem"===a.type}),ghost:a.filter(function(a){return"Ghost"===a.type}),artifact:a.filter(function(a){return"Artifact"===a.type})}}function j(a){return{titan:i(a.filter(function(a){return 0===a.classType||3===a.classType})),hunter:i(a.filter(function(a){return 1===a.classType||3===a.classType})),warlock:i(a.filter(function(a){return 2===a.classType||3===a.classType}))}}var k=this,l=[];angular.extend(k,{active:"warlock",normalize:335,doNormalize:!1,type:"Helmets",showBlues:!1,showExotics:!0,showYear1:!1,combinations:null,statOrder:"-stats.STAT_INTELLECT.value",ranked:{},filter:{"int":3,dis:2,str:2},normalizeBuckets:function(){function a(a,b){return a.normalStats=_.map(a.stats,function(b){return{statHash:b.statHash,base:(b.base*(k.doNormalize?k.normalize:a.primStat.value)/a.primStat.value).toFixed(0),scaled:b.scaled,split:b.split}}),a}var b={Helmets:_.flatten(l[k.active].helmet.map(function(b){return a(b)}),!0),Gauntlets:_.flatten(l[k.active].gauntlets.map(function(b){return a(b)}),!0),"Chest Armor":_.flatten(l[k.active].chest.map(function(b){return a(b)}),!0),"Leg Armor":_.flatten(l[k.active].leg.map(function(b){return a(b)}),!0),"Class Items":_.flatten(l[k.active].classItem.map(function(b){return a(b)}),!0),Ghosts:_.flatten(l[k.active].ghost.map(function(b){return a(b)}),!0),Artifacts:_.flatten(l[k.active].artifact.map(function(b){return a(b)}),!0)};k.ranked=b},filterFunction:function(a){return a.stats.STAT_INTELLECT.tier>=k.filter["int"]&&a.stats.STAT_DISCIPLINE.tier>=k.filter.dis&&a.stats.STAT_STRENGTH.tier>=k.filter.str},getBonus:e.getBonus,getColor:function(a){var b=0;if(85>=a)b=0;else if(90>=a)b=20;else if(95>=a)b=60;else if(99>=a)b=120;else{if(!(a>=100))return"white";b=190}return"hsl("+b+",85%,60%)"},getStore:function(a){return e.getStore(a)},getItems:function(){var a=e.getStores();if(0===a.length)return void b.go("inventory");var c=[];_.each(a,function(a,b){var d=_.filter(a.items,function(a){return a.primStat&&3897883278===a.primStat.statHash&&(k.showBlues&&"Rare"===a.tier||"Legendary"===a.tier||k.showExotics&&"Exotic"===a.tier)&&a.stats});c=c.concat(d)}),l=j(c),k.normalizeBuckets()}}),k.getItems()}angular.module("dimApp").controller("dimMinMaxCtrl",a),a.$inject=["$scope","$state","$q","loadingTracker","dimStoreService","dimItemService","ngDialog","dimLoadoutService"]}();